!function t(e,i,n){function o(s,a){if(!i[s]){if(!e[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(r)return r(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var h=i[s]={exports:{}};e[s][0].call(h.exports,function(t){var i=e[s][1][t];return o(i?i:t)},h,h.exports,t,e,i,n)}return i[s].exports}for(var r="function"==typeof require&&require,s=0;s<n.length;s++)o(n[s]);return o}({1:[function(t,e,i){"use strict";function n(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];for(var n=0,o=e;n<o.length;n++)for(var r=o[n],s=0,a=r;s<a.length;s++){var u=a[s];t.push(u)}}function o(t){i.random=t}function r(t,e,i,n){for(var o=0,r=t;o<r.length;o++){var s=r[o];s(e,i,n)}}var s=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)};i.random=function(t){return Math.floor(Math.random()*t)},i.setRandom=o;var a=function(t,e){return!1};!function(t){t[t.Choice=0]="Choice",t[t.DeepHistory=1]="DeepHistory",t[t.Initial=2]="Initial",t[t.Junction=3]="Junction",t[t.ShallowHistory=4]="ShallowHistory"}(i.PseudoStateKind||(i.PseudoStateKind={}));var u=i.PseudoStateKind;!function(t){t[t.External=0]="External",t[t.Internal=1]="Internal",t[t.Local=2]="Local"}(i.TransitionKind||(i.TransitionKind={}));var c=i.TransitionKind,h=function(){function t(e,i){this.name=e,this.parent=i,this.qualifiedName=i?i.toString()+t.namespaceSeparator+e:e,console.log("created "+this)}return t.prototype.getAncestors=function(){return this.parent.getAncestors().concat(this)},t.prototype.getRoot=function(){return this.parent.getRoot()},t.prototype.isActive=function(t){return this.parent.isActive(t)},t.prototype.accept=function(t,e){t.visitElement(this,e)},t.prototype.toString=function(){return this.qualifiedName},t.namespaceSeparator=".",t}();i.NamedElement=h;var p=function(t){function e(e,i){t.call(this,e,i),this.vertices=new Array,this.parent.regions.push(this),this.getRoot().clean=!1}return s(e,t),e.prototype.isComplete=function(t){var e=t.getCurrent(this);return void 0!==e&&e.isFinal()},e.prototype.accept=function(t,e){t.visitRegion(this,e)},e.defaultName="default",e}(h);i.Region=p;var l=function(t){function e(e,i){t.call(this,e,i instanceof p?i:i.getDefaultRegion()),this.outgoing=new Array,this.incoming=new Array,this.parent.vertices.push(this),this.getRoot().clean=!1}return s(e,t),e.prototype.to=function(t,e){return void 0===e&&(e=c.External),new y(this,t,e)},e.prototype.accept=function(t,e){t.visitVertex(this,e)},e}(h);i.Vertex=l;var f=function(t){function e(e,i,n){void 0===n&&(n=u.Initial),t.call(this,e,i),this.kind=n}return s(e,t),e.prototype.isHistory=function(){return this.kind===u.DeepHistory||this.kind===u.ShallowHistory},e.prototype.isInitial=function(){return this.kind===u.Initial||this.isHistory()},e.prototype.selectTransition=function(t,e){var n=this.outgoing.filter(function(i){return i.guard(e,t)});return this.kind===u.Choice?0!==n.length?n[i.random(n.length)]:this.findElse():(n.length>1&&console.error("Multiple outbound transition guards returned true at "+this+" for "+e),n[0]||this.findElse())},e.prototype.findElse=function(){return this.outgoing.filter(function(t){return t.guard===a})[0]},e.prototype.accept=function(t,e){t.visitPseudoState(this,e)},e}(l);i.PseudoState=f;var g=function(t){function e(e,i){t.call(this,e,i),this.regions=new Array,this.entryBehavior=new Array,this.exitBehavior=new Array}return s(e,t),e.prototype.getDefaultRegion=function(){return this.defaultRegion||(this.defaultRegion=new p(p.defaultName,this))},e.prototype.isFinal=function(){return 0===this.outgoing.length},e.prototype.isSimple=function(){return 0===this.regions.length},e.prototype.isComposite=function(){return this.regions.length>0},e.prototype.isOrthogonal=function(){return this.regions.length>1},e.prototype.exit=function(t){return this.exitBehavior.push(t),this.getRoot().clean=!1,this},e.prototype.enter=function(t){return this.exitBehavior.push(t),this.getRoot().clean=!1,this},e.prototype.isActive=function(e){return t.prototype.isActive.call(this,e)&&e.getCurrent(this.parent)===this},e.prototype.isComplete=function(t){return this.regions.every(function(e){return e.isComplete(t)})},e.prototype.evaluateState=function(t,e){var i=this,n=!1;if(e!==this&&this.regions.every(function(o){var r=t.getCurrent(o);return!r||!r.evaluateState(t,e)||(n=!0,i.isActive(t))}),n)e!==this&&this.isComplete(t)&&this.evaluateState(t,this);else{var o=this.outgoing.filter(function(i){return i.guard(e,t)});1===o.length?n=o[0].traverse(t,e):o.length>1&&console.error(this+": multiple outbound transitions evaluated true for message "+e)}return n},e.prototype.accept=function(t,e){t.visitState(this,e)},e}(l);i.State=g;var v=function(){function t(t){this.name=t,this.regions=new Array,this.defaultRegion=void 0,this.clean=!1,this.onInitialise=new Array}return t.prototype.getDefaultRegion=function(){return this.defaultRegion||(this.defaultRegion=new p(p.defaultName,this))},t.prototype.getAncestors=function(){return[this]},t.prototype.getRoot=function(){return this},t.prototype.accept=function(t,e){t.visitStateMachine(this,e)},t.prototype.isActive=function(t){return!0},t.prototype.isComplete=function(t){return this.regions.every(function(e){return e.isComplete(t)})},t.prototype.initialise=function(t,e){void 0===e&&(e=!0),t?(e&&this.clean===!1&&this.initialise(),console.log("initialise "+t),r(this.onInitialise,void 0,t,!1)):(console.log("initialise "+this),this.accept(new S),this.clean=!0)},t.prototype.evaluate=function(t,e,i,n){return void 0===n&&(n=!0),n&&t.clean===!1&&this.initialise(),console.log(e+" evaluate "+i),this.evaluateState(e,i)},t.prototype.evaluateState=function(t,e){var i=this,n=!1;return this.regions.every(function(o){var r=t.getCurrent(o);return!r||!r.evaluateState(t,e)||(n=!0,i.isActive(t))}),n},t.prototype.toString=function(){return this.name},t}();i.StateMachine=v;var y=function(){function t(t,e,i){var n=this;void 0===i&&(i=c.External),this.source=t,this.target=e,this.kind=i,this.effectBehavior=new Array,this.onTraverse=new Array,this.guard=t instanceof f?function(){return!0}:function(t){return t===n.source},this.source.outgoing.push(this),this.source.getRoot().clean=!1,this.target?this.target.incoming.push(this):this.kind=c.Internal,console.log("created transition from "+t+" to "+e)}return t.prototype.else=function(){return this.guard=a,this},t.prototype.when=function(t){return this.guard=t,this},t.prototype.effect=function(t){return this.effectBehavior.push(t),this.source.getRoot().clean=!1,this},t.prototype.traverse=function(t,e){for(var i=this.onTraverse.slice(0),o=this;o.target&&o.target instanceof f&&o.target.kind===u.Junction;)o=o.target.selectTransition(t,e),n(i,o.onTraverse);return r(i,e,t,!1),o.target&&(o.target instanceof f&&o.target.kind===u.Choice?o.target.selectTransition(t,e).traverse(t,e):o.target instanceof g&&o.target.isComplete(t)&&o.target.evaluateState(t,o.target)),!0},t.prototype.accept=function(t,e){t.visitTransition(this,e)},t.prototype.toString=function(){return c[this.kind]+"("+(this.kind===c.Internal?this.source:this.source+" -> "+this.target)+")"},t}();i.Transition=y;var d=function(){function t(){}return t.prototype.visitElement=function(t,e){console.log("visiting "+t.toString())},t.prototype.visitRegion=function(t,e){for(var i=0,n=t.vertices;i<n.length;i++){var o=n[i];o.accept(this,e)}this.visitElement(t,e)},t.prototype.visitVertex=function(t,e){for(var i=0,n=t.outgoing;i<n.length;i++){var o=n[i];o.accept(this,e)}this.visitElement(t,e)},t.prototype.visitPseudoState=function(t,e){this.visitVertex(t,e)},t.prototype.visitState=function(t,e){for(var i=0,n=t.regions;i<n.length;i++){var o=n[i];o.accept(this,e)}this.visitVertex(t,e)},t.prototype.visitStateMachine=function(t,e){for(var i=0,n=t.regions;i<n.length;i++){var o=n[i];o.accept(this,e)}this.visitElement(t,e)},t.prototype.visitTransition=function(t,e){console.log("visiting "+t)},t}();i.Visitor=d;var m=function(){function t(t){this.name=t,this.activeStateConfiguration={}}return t.prototype.setCurrent=function(t,e){this.activeStateConfiguration[t.qualifiedName]=e},t.prototype.getCurrent=function(t){return this.activeStateConfiguration[t.qualifiedName]},t.prototype.toString=function(){return this.name},t}();i.DictionaryInstance=m;var S=function(t){function e(){t.apply(this,arguments),this.elementActions={},this.transitions=new Array}return s(e,t),e.prototype.getActions=function(t){return this.elementActions[t.toString()]||(this.elementActions[t.toString()]={leave:[],beginEnter:[],endEnter:[]})},e.prototype.visitElement=function(t,e){this.getActions(t).leave.push(function(e,i){return console.log(i+" leave "+t)}),this.getActions(t).beginEnter.push(function(e,i){return console.log(i+" enter "+t)})},e.prototype.visitRegion=function(e,i){var o=this,s=e.vertices.reduce(function(t,e){return e instanceof f&&e.isInitial()&&(void 0===t||t.isHistory())?e:t},void 0);t.prototype.visitRegion.call(this,e,i||s&&s.kind===u.DeepHistory),this.getActions(e).leave.push(function(t,i){var n=i.getCurrent(e);n&&r(o.getActions(n).leave,t,i,!1)}),i||!s||s.isHistory()?this.getActions(e).endEnter.push(function(t,i,n){var a=o.getActions(n||s.isHistory()?i.getCurrent(e)||s:s),c=n||s.kind===u.DeepHistory;r(a.beginEnter,t,i,c),r(a.endEnter,t,i,c)}):n(this.getActions(e).endEnter,this.getActions(s).beginEnter,this.getActions(s).endEnter)},e.prototype.visitPseudoState=function(e,i){var n=this;t.prototype.visitPseudoState.call(this,e,i),e.isInitial()&&this.getActions(e).endEnter.push(function(t,i,o){if(i.getCurrent(e.parent)){r(n.getActions(e).leave,t,i,!1);var s=i.getCurrent(e.parent);s&&(r(n.getActions(s).beginEnter,t,i,o||e.kind===u.DeepHistory),r(n.getActions(s).endEnter,t,i,o||e.kind===u.DeepHistory))}else e.outgoing[0].traverse(i)})},e.prototype.visitTransition=function(e,i){t.prototype.visitTransition.call(this,e,i),this.transitions.push(e)},e.prototype.visitStateMachine=function(e,i){t.prototype.visitStateMachine.call(this,e,i);for(var o=0,r=this.transitions;o<r.length;o++){var s=r[o];console.log("init trans: "+s)}for(var a=0,u=e.regions;a<u.length;a++){var c=u[a];n(e.onInitialise,this.getActions(c).beginEnter,this.getActions(c).endEnter)}},e}(d)},{}],2:[function(t,e,i){window[((document.currentScript||document.getElementsByTagName("script")[scripts.length-1]).attributes.target||{textContent:"fsm"}).textContent]=t("../lib/node/state.js")},{"../lib/node/state.js":1}]},{},[2]);
