<!DOCTYPE html>
<html>
	<head>
		<title>state.js test results</title>
		<script src="../src/state.js"></script>
		<script>
			function result( text ) {
				document.getElementById("results").appendChild(document.createTextNode( text ));
				document.getElementById("results").appendChild(document.createElement( "br" ));
			}
			
			function compTest()
			{
                var machine = new FSM.StateMachine("compTest");
                var initial = new FSM.PseudoState("initial", machine, FSM.PseudoStateKind.Initial)

                var activity1 = new FSM.State("activity1", machine );
				var activity2 = new FSM.State("activity2", machine);
				var activity3 = new FSM.State("activity3", machine);
				var junction1 = new FSM.PseudoState("junction1", machine, FSM.PseudoStateKind.Junction);
				var junction2 = new FSM.PseudoState("junction2", machine, FSM.PseudoStateKind.Junction);
				var end       = new FSM.FinalState("end", machine);

                var subInitial = new FSM.PseudoState("subInitial", activity2, FSM.PseudoStateKind.Initial);
				var subEnd     = new FSM.FinalState("subEnd", activity2);
			
                subInitial.to(subEnd);
				initial.to(activity1);
				activity1.to(activity2);
				activity2.to(junction1);
				junction1.to(junction2);
				junction2.to(activity3);
				activity3.to(end);
                
                var sms = new FSM.Context();

				machine.initialise( sms );
								
				result( "Completion Transitions: " + ( machine.isComplete( sms ) ? "passed" : "failed" ) );
			}

			function shallowTest()
			{
                var machine = new FSM.StateMachine( "history" );
    
                var initial = new FSM.PseudoState( "initial", machine, FSM.PseudoStateKind.Initial);
                var shallow = new FSM.State( "shallow", machine );
                var deep = new FSM.State( "deep", machine );
                var end = new FSM.FinalState( "final", machine );
    
                var s1 = new FSM.State( "s1", shallow );
                var s2 = new FSM.State( "s2", shallow );
    
                initial.to(shallow);
                new FSM.PseudoState( "shallow", shallow, FSM.PseudoStateKind.ShallowHistory).to( s1 );
                s1.to(s2).when(function(c) { return c === "move";} );
                shallow.to(deep).when(function(c) { return c === "go deep";} );
                deep.to(shallow).when(function(c) { return c === "go shallow";} );
                s2.to(end).when(function(c) { return c === "end"; } );

                var sms = new FSM.Context();

				machine.initialise( sms );

				result( "Shallow History (1): " + machine.evaluate( "move", sms ) );
				result( "Shallow History (2): " + machine.evaluate( "go deep", sms ) );
				result( "Shallow History (3): " + machine.evaluate( "go shallow", sms ) );
				result( "Shallow History (4): " + machine.evaluate( "end", sms ) );
			
				result( "Shallow History: " + ( machine.isComplete( sms ) ? "passed" : "failed" ) );
			}

            function muximise1() {
                var main = new FSM.StateMachine("muximise1");

                var initial = new FSM.PseudoState("initial", main, FSM.PseudoStateKind.Initial);
                var ortho = new FSM.State("ortho", main);
                var simple = new FSM.State("simple", main);
                var final = new FSM.FinalState("final", main);

                var r1 = new FSM.Region("r1", ortho);
                var r2 = new FSM.Region("r2", ortho);

                var i1 = new FSM.PseudoState("initial", r1, FSM.PseudoStateKind.ShallowHistory);
                var i2 = new FSM.PseudoState("initial", r2, FSM.PseudoStateKind.ShallowHistory);

                var s1 = new FSM.State("s1", r1);
                var s2 = new FSM.State("s2", r2);

                var f1 = new FSM.FinalState("f1", r1);
                var f2 = new FSM.FinalState("f2", r2);

                initial.to(ortho);

                i1.to(s1);
                i2.to(s2);

                ortho.to(final); // This should happen once all regions in ortho are complete?

                s1.to(f1).when(function(c) {
                    return c === "complete1";
                });

                s2.to(f2).when(function(c) {
                    return c === "complete2";
                });

                ortho.to(simple).when(function(c) {
                    return c === "jump";
                });

                simple.to(ortho).when(function(c) {
                    return c === "back";
                });
                
                var state = new FSM.Context();				
				main.initialise(state);

                main.evaluate("complete1", state);
                main.evaluate("complete2", state)
            
            	result("Muximuse test 1: " + (main.isComplete(state) ? "passed" : "failed"));
            }
            
            function brice1() {
                var main = new FSM.StateMachine("brice");
                var initial1 = new FSM.PseudoState("initial", main, FSM.PseudoStateKind.Initial);
                var myComposite1 = new FSM.State("MyComposite1", main);
                var myComposite2 = new FSM.State("MyComposite2", main);
                var initial2 = new FSM.PseudoState("initial", myComposite1, FSM.PseudoStateKind.Initial);
                var state1 = new FSM.State("State1", myComposite1);
                var state2 = new FSM.State("State1", myComposite1);
                
                initial1.to(myComposite1);
                initial2.to(state1);
                myComposite1.to(myComposite2).when(function(c) { return c === "A";}).effect(function() { result("Brice test1: failed"); });
                state1.to(state2).when(function(c) { return c === "A";}).effect(function() { result("Brice test1: passed"); });
                
                var state = new FSM.Context();	
				main.initialise(state);

                main.evaluate("A", state);
            }
            
			function run()
			{
				compTest();
				shallowTest();
                muximise1();
                brice1();
			}			
		</script>
	</head>
	<body onload="run()">
		<h1>state.js test results</h1>
		<div id="results"/>
	</body>
</html>