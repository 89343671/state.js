/**
 * state v5 finite state machine library
 * http://www.steelbreeze.net/state.cs
 * Copyright (c) 2014-5 Steelbreeze Limited
 * Licensed under the MIT and GPL v3 licences
 */
var __extends=this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])
i.prototype=e.prototype,t.prototype=new i},fsm
!function(t){function e(t,e,i,n){for(var r=0,o=t.length;o>r;r++)t[r](e,i,n)}function i(t,e){if(!t)throw e}var n=function(){function t(){}return t.prototype.visitElement=function(){},t.prototype.visitRegion=function(t,e){this.visitElement(t,e)
for(var i=0,n=t.vertices.length;n>i;i++)t.vertices[i].accept(this,e)},t.prototype.visitVertex=function(t,e){this.visitElement(t,e)
for(var i=0,n=t.transitions.length;n>i;i++)t.transitions[i].accept(this,e)},t.prototype.visitPseudoState=function(t,e){this.visitVertex(t,e)},t.prototype.visitState=function(t,e){this.visitVertex(t,e)
for(var i=0,n=t.regions.length;n>i;i++)t.regions[i].accept(this,e)},t.prototype.visitFinalState=function(t,e){this.visitState(t,e)},t.prototype.visitStateMachine=function(t,e){this.visitState(t,e)},t.prototype.visitTransition=function(){},t}()
t.Visitor=n
var r=(function(){function t(){}return t}(),function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.visitTransition=function(t){if(null===t.target)t.traverse=t.transitionBehavior
else if(t.target.getParent()===t.source.getParent())t.traverse=t.source.leave.concat(t.transitionBehavior).concat(t.target.enter)
else{for(var e=t.source.ancestors(),n=t.target.ancestors(),r=e.length,o=n.length,s=0,u=Math.min(r,o);u>s&&e[s]===n[s];)s++
for(i(!(e[s]instanceof a),"Transitions may not cross sibling orthogonal region boundaries"),t.traverse=(r>s?e[s]:t.source).leave.slice(0),t.traverse=t.traverse.concat(t.transitionBehavior),s>=o&&(t.traverse=t.traverse.concat(t.target.beginEnter));o>s;){var c=n[s++],p=o>s?n[s]:void 0
if(t.traverse=t.traverse.concat(c.beginEnter),c instanceof h){var l=c
if(l.isOrthogonal())for(var f=0,v=l.regions.length;v>f;f++){var g=l.regions[f]
g!==p&&(t.traverse=t.traverse.concat(g.enter))}}}t.traverse=t.traverse.concat(t.target.endEnter)}},e}(n)),o=function(t){function i(){t.apply(this,arguments)}return __extends(i,t),i.prototype.elementBehaviour=function(){},i.prototype.visitElement=function(t){t.qualifiedName=t.ancestors().map(function(t){return t.name}).join(s.namespaceSeparator),t.leave.push(function(e,i){console.log(i+" leave "+t)}),t.beginEnter.push(function(e,i){console.log(i+" enter "+t)}),t.enter=t.beginEnter.concat(t.endEnter)},i.prototype.visitRegion=function(t,i){for(var n=0,r=t.vertices.length;r>n;n++)t.vertices[n].reset(),t.vertices[n].accept(this,i||t.initial&&2===t.initial.kind)
t.leave.push(function(i,n,r){var o=n.getCurrent(t)
o.leave&&e(o.leave,i,n,r)}),i||!t.initial||t.initial.isHistory()?t.endEnter.push(function(i,n,r){var o=t.initial;(r||t.initial.isHistory())&&(o=n.getCurrent(t)||t.initial),e(o.enter,i,n,r||2===t.initial.kind)}):t.endEnter=t.endEnter.concat(t.initial.enter),this.visitElement(t,i)},i.prototype.visitVertex=function(t,e){this.visitElement(t,e),t.endEnter.push(function(e,i,n){t.evaluateCompletions(e,i,n)}),t.enter=t.beginEnter.concat(t.endEnter)},i.prototype.visitPseudoState=function(t,e){this.visitVertex(t,e),5===t.kind&&t.enter.push(function(t,e){e.isTerminated=!0})},i.prototype.visitState=function(t,i){for(var n=0,r=t.regions.length;r>n;n++){var o=t.regions[n]
o.reset(),o.accept(this,i),t.leave.push(function(t,i,n){e(o.leave,t,i,n)}),t.endEnter=t.endEnter.concat(o.enter)}this.visitVertex(t,i),t.leave=t.leave.concat(t.exitBehavior),t.beginEnter=t.beginEnter.concat(t.entryBehavior),t.beginEnter.push(function(e,i){t.region&&i.setCurrent(t.region,t)}),t.enter=t.beginEnter.concat(t.endEnter)},i.prototype.visitStateMachine=function(t,e){this.visitState(t,e),t.accept(i.bootstrapTransitions,this.elementBehaviour)},i.bootstrapTransitions=new r,i}(n),s=function(){function t(t){this.name=t,this.leave=[],this.beginEnter=[],this.endEnter=[],this.enter=[]}return t.prototype.getParent=function(){},t.prototype.root=function(){return this.getParent().root()},t.prototype.ancestors=function(){return(this.getParent()?this.getParent().ancestors():[]).concat(this)},t.prototype.isActive=function(t){return this.getParent().isActive(t)},t.prototype.reset=function(){this.leave=[],this.beginEnter=[],this.endEnter=[],this.enter=[]},t.prototype.toString=function(){return this.qualifiedName},t.namespaceSeparator=".",t}()
t.Element=s
var a=function(t){function e(e,i){t.call(this,e),this.parent=i,this.vertices=[],i.regions.push(this),i.root().clean=!1}return __extends(e,t),e.prototype.getParent=function(){return this.parent},e.prototype.isComplete=function(t){return t.getCurrent(this).isFinal()},e.prototype.evaluate=function(t,e){return e.getCurrent(this).evaluate(t,e)},e.prototype.accept=function(t,e){t.visitRegion(this,e)},e.defaultName="default",e}(s)
t.Region=a
var u=function(t){function i(e,i){t.call(this,e),this.transitions=[],i instanceof a?this.region=i:i instanceof h&&(this.region=i.defaultRegion()),this.region&&(this.region.vertices.push(this),this.region.root().clean=!1)}return __extends(i,t),i.prototype.getParent=function(){return this.region},i.prototype.isComplete=function(){},i.prototype.to=function(t){var e=new f(this,t)
return this.transitions.push(e),this.root().clean=!1,e},i.prototype.evaluateCompletions=function(t,e){this.isComplete(e)&&this.evaluate(this,e)},i.prototype.select=function(){},i.prototype.evaluate=function(t,i){var n=this.select(t,i)
return n?(e(n.traverse,t,i,!1),!0):!1},i.prototype.accept=function(){},i}(s)
t.Vertex=u,function(t){t[t.Initial=0]="Initial",t[t.ShallowHistory=1]="ShallowHistory",t[t.DeepHistory=2]="DeepHistory",t[t.Choice=3]="Choice",t[t.Junction=4]="Junction",t[t.Terminate=5]="Terminate"}(t.PseudoStateKind||(t.PseudoStateKind={}))
var c=(t.PseudoStateKind,function(t){function e(e,i,n){t.call(this,e,i),this.kind=n,this.isInitial()&&(this.region.initial=this)}return __extends(e,t),e.prototype.isComplete=function(){return!0},e.prototype.isHistory=function(){return 2===this.kind||1===this.kind},e.prototype.isInitial=function(){return 0===this.kind||this.isHistory()},e.prototype.select=function(t,e){switch(this.kind){case 0:case 2:case 1:if(1===this.transitions.length)return this.transitions[0]
throw"Initial transition must have a single outbound transition from "+this.qualifiedName
case 4:for(var i,n,r=0,o=this.transitions.length;o>r;r++)if(this.transitions[r].guard===f.isElse){if(n)throw"Multiple outbound transitions evaluated true"
n=this.transitions[r]}else if(this.transitions[r].guard(t,e)){if(i)throw"Multiple outbound transitions evaluated true"
i=this.transitions[r]}return i||n
case 3:for(var s=[],r=0,o=this.transitions.length;o>r;r++)if(this.transitions[r].guard===f.isElse){if(n)throw"Multiple outbound else transitions found at "+this+" for "+t
n=this.transitions[r]}else this.transitions[r].guard(t,e)&&s.push(this.transitions[r])
return 0!==s.length?s[Math.round((s.length-1)*Math.random())]:n
default:return null}},e.prototype.accept=function(t,e){t.visitPseudoState(this,e)},e}(u))
t.PseudoState=c
var h=function(t){function e(e,i){t.call(this,e,i),this.exitBehavior=[],this.entryBehavior=[],this.regions=[]}return __extends(e,t),e.prototype.defaultRegion=function(){for(var t,e=0,i=this.regions.length;i>e;e++)this.regions[e].name===a.defaultName&&(t=this.regions[e])
return t||(t=new a(a.defaultName,this)),t},e.prototype.isActive=function(e){return t.prototype.isActive.call(this,e)&&e.getCurrent(this.region)===this},e.prototype.isFinal=function(){return 0===this.transitions.length},e.prototype.isSimple=function(){return 0===this.regions.length},e.prototype.isComposite=function(){return this.regions.length>0},e.prototype.isOrthogonal=function(){return this.regions.length>1},e.prototype.isComplete=function(t){for(var e=0,i=this.regions.length;i>e;e++)if(this.regions[e].isComplete(t)===!1)return!1
return!0},e.prototype.exit=function(t){return this.exitBehavior.push(t),this.root().clean=!1,this},e.prototype.entry=function(t){return this.entryBehavior.push(t),this.root().clean=!1,this},e.prototype.select=function(t,e){for(var i,n=0,r=this.transitions.length;r>n;n++)if(this.transitions[n].guard(t,e)){if(i)throw"Multiple outbound transitions evaluated true"
i=this.transitions[n]}return i},e.prototype.evaluate=function(e,i){for(var n=!1,r=0,o=this.regions.length;o>r;r++)this.isActive(i)===!0&&this.regions[r].evaluate(e,i)&&(n=!0)
return n===!1&&(n=t.prototype.evaluate.call(this,e,i)),n===!0&&e!==this&&this.evaluateCompletions(this,i,!1),n},e.prototype.accept=function(t,e){t.visitState(this,e)},e}(u)
t.State=h
var p=function(t){function e(e,i){t.call(this,e,i)}return __extends(e,t),e.prototype.to=function(){throw"A FinalState cannot be the source of a transition."},e.prototype.accept=function(t,e){t.visitFinalState(this,e)},e}(h)
t.FinalState=p
var l=function(t){function i(e){t.call(this,e,void 0),this.clean=!0}return __extends(i,t),i.prototype.root=function(){return this},i.prototype.isActive=function(){return!0},i.prototype.initialiseModel=function(){t.prototype.reset.call(this),this.clean=!0,this.accept(i.bootstrap,!1)},i.prototype.initialise=function(t,i){void 0===i&&(i=!0),i&&this.clean===!1&&this.initialiseModel(),e(this.enter,void 0,t,!1)},i.prototype.evaluate=function(e,i,n){return void 0===n&&(n=!0),n&&this.clean===!1&&this.initialiseModel(),i.isTerminated?!1:t.prototype.evaluate.call(this,e,i)},i.prototype.accept=function(t,e){t.visitStateMachine(this,e)},i.bootstrap=new o,i}(h)
t.StateMachine=l
var f=function(){function t(t,e){var i=this
this.source=t,this.target=e,this.transitionBehavior=[],this.traverse=[],this.guard=function(t){return t===i.source}}return t.prototype["else"]=function(){return this.guard=t.isElse,this},t.prototype.when=function(t){return this.guard=t,this},t.prototype.effect=function(t){return this.transitionBehavior.push(t),this.source.root().clean=!1,this},t.prototype.accept=function(t,e){t.visitTransition(this,e)},t.isElse=function(){return!1},t}()
t.Transition=f
var v=function(){function t(t){void 0===t&&(t="unnamed"),this.name=t,this.isTerminated=!1,this.last={}}return t.prototype.setCurrent=function(t,e){this.last[t.qualifiedName]=e},t.prototype.getCurrent=function(t){return this.last[t.qualifiedName]},t.prototype.toString=function(){return this.name},t}()
t.StateMachineInstance=v}(fsm||(fsm={}))
