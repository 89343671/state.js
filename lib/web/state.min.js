!function t(n,e,i){function r(s,a){if(!e[s]){if(!n[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(o)return o(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var h=e[s]={exports:{}};n[s][0].call(h.exports,function(t){var e=n[s][1][t];return r(e?e:t)},h,h.exports,t,n,e,i)}return e[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s]);return r}({1:[function(t,n,e){"use strict";function i(t){var n=e.logger;return e.logger=t,n}function r(t){var n=e.random;return e.random=t,n}function o(t){var n=e.internalTransitionsTriggerCompletion;return e.internalTransitionsTriggerCompletion=t,n}function s(t,n,e,i){for(var r=0,o=t;r<o.length;r++){var s=o[r];s(n,e,i)}}function a(t){return t.outgoing.filter(function(t){return t.guard===w.Else})[0]}function c(t,n,i){var r=t.outgoing.filter(function(t){return t.guard(i,n)});return t.kind===f.Choice?0!==r.length?r[e.random(r.length)]:a(t):(r.length>1&&e.logger.error("Multiple outbound transition guards returned true at "+t+" for "+i),r[0]||a(t))}function u(t,n,i){var r=!1;if(i!==t&&t.children.every(function(e){var o=n.getLastKnownState(e);return!o||!u(o,n,i)||(r=!0,t.isActive(n))}),t instanceof m)if(r)i!==t&&t.isComplete(n)&&u(t,n,t);else{var o=t.outgoing.filter(function(t){return t.guard(i,n)});1===o.length?(h(o[0],n,i),r=!0):o.length>1&&e.logger.error(t+": multiple outbound transitions evaluated true for message "+i)}return r}function h(t,n,e){for(var i=t.onTraverse.slice(),r=t;r.target&&r.target instanceof A&&r.target.kind===f.Junction;)r=c(r.target,n,e),i=i.concat(r.onTraverse);s(i,e,n,!1),r.target&&(r.target instanceof A&&r.target.kind===f.Choice?h(c(r.target,n,e),n,e):r.target instanceof m&&r.target.isComplete(n)&&u(r.target,n,r.target))}var l=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e])};return function(n,e){function i(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();e.__esModule=!0;var p=t("./tree");e.logger={log:function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e]},error:function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];throw t}},e.setLogger=i,e.random=function(t){return Math.floor(Math.random()*t)},e.setRandom=r,e.internalTransitionsTriggerCompletion=!1,e.setInternalTransitionsTriggerCompletion=o;var f;!function(t){t[t.Choice=0]="Choice",t[t.DeepHistory=1]="DeepHistory",t[t.Initial=2]="Initial",t[t.Junction=3]="Junction",t[t.ShallowHistory=4]="ShallowHistory"}(f=e.PseudoStateKind||(e.PseudoStateKind={}));var g;!function(t){t[t.External=0]="External",t[t.Internal=1]="Internal",t[t.Local=2]="Local"}(g=e.TransitionKind||(e.TransitionKind={}));var v=function(){function t(n,e){this.name=n,this.parent=e,this.children=new Array,this.qualifiedName=e?e.toString()+t.namespaceSeparator+n:n}return t.prototype.getRoot=function(){return this.parent.getRoot()},t.prototype.isActive=function(t){return this.parent.isActive(t)},t.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitElement.apply(t,[this].concat(n))},t.prototype.toString=function(){return this.qualifiedName},t}();v.namespaceSeparator=".",e.Element=v;var y=function(t){function n(n,e){var i=t.call(this,n,e)||this;return i.parent.children.push(i),i.getRoot().clean=!1,i}return l(n,t),n.prototype.isComplete=function(t){var n=t.getLastKnownState(this);return void 0!==n&&n.isFinal()},n.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitRegion.apply(t,[this].concat(n))},n}(v);y.defaultName="default",e.Region=y;var d=function(t){function n(n,e){var i=t.call(this,n,e instanceof y?e:m.defaultRegion(e))||this;return i.outgoing=new Array,i.incoming=new Array,i.parent.children.push(i),i.getRoot().clean=!1,i}return l(n,t),n.prototype.to=function(t,n){return void 0===n&&(n=g.External),new w(this,t,n)},n.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitVertex.apply(t,[this].concat(n))},n}(v);e.Vertex=d;var A=function(t){function n(n,e,i){void 0===i&&(i=f.Initial);var r=t.call(this,n,e)||this;return r.kind=i,r}return l(n,t),n.prototype.isHistory=function(){return this.kind===f.DeepHistory||this.kind===f.ShallowHistory},n.prototype.isInitial=function(){return this.kind===f.Initial||this.isHistory()},n.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitPseudoState.apply(t,[this].concat(n))},n}(d);e.PseudoState=A;var m=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.entryBehavior=new Array,n.exitBehavior=new Array,n}return l(n,t),n.defaultRegion=function(t){for(var n=0,e=t.children;n<e.length;n++){var i=e[n];if(i.name===y.defaultName)return i}return new y(y.defaultName,t)},n.prototype.isFinal=function(){return 0===this.outgoing.length},n.prototype.isSimple=function(){return 0===this.children.length},n.prototype.isComposite=function(){return this.children.length>0},n.prototype.isOrthogonal=function(){return this.children.length>1},n.prototype.isActive=function(n){return t.prototype.isActive.call(this,n)&&n.getLastKnownState(this.parent)===this},n.prototype.isComplete=function(t){return this.children.every(function(n){return n.isComplete(t)})},n.prototype.exit=function(t){return this.exitBehavior.push(t),this.getRoot().clean=!1,this},n.prototype.entry=function(t){return this.entryBehavior.push(t),this.getRoot().clean=!1,this},n.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitState.apply(t,[this].concat(n))},n}(d);e.State=m;var E=function(){function t(t){this.name=t,this.children=new Array,this.clean=!1,this.onInitialise=new Array,this.parent=void 0}return t.prototype.getRoot=function(){return this},t.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitStateMachine.apply(t,[this].concat(n))},t.prototype.isActive=function(t){return!0},t.prototype.isComplete=function(t){return this.children.every(function(n){return n.isComplete(t)})},t.prototype.initialise=function(t,n){void 0===n&&(n=!0),t?(n&&this.clean===!1&&this.initialise(),e.logger.log("initialise "+t),s(this.onInitialise,void 0,t,!1)):(e.logger.log("initialise "+this),this.accept(new x,!1),this.clean=!0)},t.prototype.evaluate=function(t,n,i){return void 0===i&&(i=!0),i&&this.clean===!1&&this.initialise(),e.logger.log(t+" evaluate message: "+n),u(this,t,n)},t.prototype.toString=function(){return this.name},t}();e.StateMachine=E;var w=function(){function t(t,n,e){void 0===e&&(e=g.External);var i=this;this.source=t,this.target=n,this.kind=e,this.effectBehavior=new Array,this.onTraverse=new Array,this.guard=t instanceof A?function(){return!0}:function(t){return t===i.source},this.source.outgoing.push(this),this.source.getRoot().clean=!1,this.target?this.target.incoming.push(this):this.kind=g.Internal}return t.prototype.else=function(){return this.guard=t.Else,this},t.prototype.when=function(t){return this.guard=t,this},t.prototype.effect=function(t){return this.effectBehavior.push(t),this.source.getRoot().clean=!1,this},t.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitTransition.apply(t,[this].concat(n))},t.prototype.toString=function(){return g[this.kind]+"("+(this.kind===g.Internal?this.source:this.source+" -> "+this.target)+")"},t}();w.Else=function(t,n){return!1},e.Transition=w;var S=function(){function t(){}return t.prototype.visitElement=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e]},t.prototype.visitRegion=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=0,r=t.children;i<r.length;i++){var o=r[i];o.accept.apply(o,[this].concat(n))}this.visitElement.apply(this,[t].concat(n))},t.prototype.visitVertex=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=0,r=t.outgoing;i<r.length;i++){var o=r[i];o.accept.apply(o,[this].concat(n))}this.visitElement.apply(this,[t].concat(n))},t.prototype.visitPseudoState=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];this.visitVertex.apply(this,[t].concat(n))},t.prototype.visitState=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=0,r=t.children;i<r.length;i++){var o=r[i];o.accept.apply(o,[this].concat(n))}this.visitVertex.apply(this,[t].concat(n))},t.prototype.visitStateMachine=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=0,r=t.children;i<r.length;i++){var o=r[i];o.accept.apply(o,[this].concat(n))}this.visitElement.apply(this,[t].concat(n))},t.prototype.visitTransition=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e]},t}();e.Visitor=S;var T=function(){function t(t){this.name=t,this.current={},this.activeStateConfiguration={}}return t.prototype.setCurrent=function(t,n){this.current[t.qualifiedName]=n,n instanceof m&&(this.activeStateConfiguration[t.qualifiedName]=n)},t.prototype.getCurrent=function(t){return this.current[t.qualifiedName]},t.prototype.getLastKnownState=function(t){return this.activeStateConfiguration[t.qualifiedName]},t.prototype.toString=function(){return this.name},t}();e.DictionaryInstance=T;var C=function(){function t(){this.leave=new Array,this.beginEnter=new Array,this.endEnter=new Array}return t}(),x=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.elementActions={},n.transitions=new Array,n}return l(n,t),n.prototype.getActions=function(t){return this.elementActions[t.toString()]||(this.elementActions[t.toString()]=new C)},n.prototype.visitElement=function(t,n){this.getActions(t).leave.push(function(n,i){return e.logger.log(i+" leave "+t)}),this.getActions(t).beginEnter.push(function(n,i){return e.logger.log(i+" enter "+t)})},n.prototype.visitRegion=function(n,e){var i=this,r=n.children.reduce(function(t,n){return n instanceof A&&n.isInitial()&&(void 0===t||t.isHistory())?n:t},void 0);this.getActions(n).leave.push(function(t,e){var r=e.getCurrent(n);r&&s(i.getActions(r).leave,t,e,!1)}),t.prototype.visitRegion.call(this,n,e||r&&r.kind===f.DeepHistory),e||!r||r.isHistory()?this.getActions(n).endEnter.push(function(t,e,o){var a=i.getActions(o||r.isHistory()?e.getLastKnownState(n)||r:r),c=o||r.kind===f.DeepHistory;s(a.beginEnter,t,e,c),s(a.endEnter,t,e,c)}):this.getActions(n).endEnter=this.getActions(n).endEnter.concat(this.getActions(r).beginEnter,this.getActions(r).endEnter)},n.prototype.visitVertex=function(n,e){t.prototype.visitVertex.call(this,n,e),this.getActions(n).beginEnter.push(function(t,e){e.setCurrent(n.parent,n)})},n.prototype.visitPseudoState=function(n,e){var i=this;t.prototype.visitPseudoState.call(this,n,e),n.isInitial()&&this.getActions(n).endEnter.push(function(t,e,r){if(e.getLastKnownState(n.parent)){s(i.getActions(n).leave,t,e,!1);var o=e.getLastKnownState(n.parent);o&&(s(i.getActions(o).beginEnter,t,e,r||n.kind===f.DeepHistory),s(i.getActions(o).endEnter,t,e,r||n.kind===f.DeepHistory))}else h(n.outgoing[0],e)})},n.prototype.visitState=function(t,n){for(var e=0,i=t.children;e<i.length;e++){var r=i[e];r.accept(this,n),this.getActions(t).leave=this.getActions(t).leave.concat(this.getActions(r).leave),this.getActions(t).endEnter=this.getActions(t).endEnter.concat(this.getActions(r).beginEnter,this.getActions(r).endEnter)}this.visitVertex(t,n),this.getActions(t).leave=this.getActions(t).leave.concat(t.exitBehavior),this.getActions(t).beginEnter=this.getActions(t).beginEnter.concat(t.entryBehavior)},n.prototype.visitStateMachine=function(n,e){t.prototype.visitStateMachine.call(this,n,e);for(var i=0,r=this.transitions;i<r.length;i++){var o=r[i];switch(o.kind){case g.Internal:this.visitInternalTransition(o);break;case g.Local:this.visitLocalTransition(o);break;case g.External:this.visitExternalTransition(o)}}for(var s=0,a=n.children;s<a.length;s++){var c=a[s];n.onInitialise=n.onInitialise.concat(this.getActions(c).beginEnter,this.getActions(c).endEnter)}},n.prototype.visitTransition=function(n,e){t.prototype.visitTransition.call(this,n,e),this.transitions.push(n)},n.prototype.visitInternalTransition=function(t){t.onTraverse=t.onTraverse.concat(t.effectBehavior),e.internalTransitionsTriggerCompletion&&t.onTraverse.push(function(n,e){t.source instanceof m&&t.source.isComplete(e)&&u(t.source,e,t.source)})},n.prototype.visitLocalTransition=function(t){var n=this;t.onTraverse.push(function(e,i,r){for(var o=p.Ancestors(t.target),a=0;o[a].isActive(i);)a++;if(o[a]instanceof y)throw"Need to implement Region logic";var c=o[a],u=i.getCurrent(c.parent);for(s(n.getActions(u).leave,e,i,!1),s(t.effectBehavior,e,i,!1);a<o.length;)s(n.getActions(o[a++]).beginEnter,e,i,!1);s(n.getActions(t.target).endEnter,e,i,!1)})},n.prototype.visitExternalTransition=function(t){var n=p.Ancestors(t.source),e=p.Ancestors(t.target),i=p.LowestCommonAncestorIndex(n,e);for(n[i]instanceof y&&(i+=1),t.onTraverse=t.onTraverse.concat(this.getActions(n[i]).leave,t.effectBehavior);i<e.length;)t.onTraverse=t.onTraverse.concat(this.getActions(e[i++]).beginEnter);t.onTraverse=t.onTraverse.concat(this.getActions(t.target).endEnter)},n}(S)},{"./tree":2}],2:[function(t,n,e){"use strict";function i(t){var n=t.parent?i(t.parent):new Array;return n.push(t),n}function r(t,n){for(var e=0;e<t.length&&e<n.length&&t[e]===n[e];)e++;return e-1}e.__esModule=!0,e.Ancestors=i,e.LowestCommonAncestorIndex=r},{}],3:[function(t,n,e){window[((document.currentScript||document.getElementsByTagName("script")[scripts.length-1]).attributes.target||{textContent:"fsm"}).textContent]=t("../lib/node/state.js")},{"../lib/node/state.js":1}]},{},[3]);
