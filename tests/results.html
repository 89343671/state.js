<!DOCTYPE html>
<html>
	<head>
		<title>state.js v5.2.0 tests</title>
    <script src="../src/state.js"></script>
		<script>
			function result( text ) {
				document.getElementById("results").appendChild(document.createTextNode( text ));
				document.getElementById("results").appendChild(document.createElement( "br" ));
			}
			
			function compTest()
			{
                var machine = new fsm.StateMachine("compTest");
                var initial = new fsm.PseudoState("initial", machine, fsm.PseudoStateKind.Initial)

                var activity1 = new fsm.State("activity1", machine );
				var activity2 = new fsm.State("activity2", machine);
				var activity3 = new fsm.State("activity3", machine);
				var junction1 = new fsm.PseudoState("junction1", machine, fsm.PseudoStateKind.Junction);
				var junction2 = new fsm.PseudoState("junction2", machine, fsm.PseudoStateKind.Junction);
				var end       = new fsm.FinalState("end", machine);

                var subInitial = new fsm.PseudoState("subInitial", activity2, fsm.PseudoStateKind.Initial);
				var subEnd     = new fsm.FinalState("subEnd", activity2);
			
                subInitial.to(subEnd);
				initial.to(activity1);
				activity1.to(activity2);
				activity2.to(junction1);
				junction1.to(junction2);
				junction2.to(activity3);
				activity3.to(end);
                
                var sms = new fsm.StateMachineInstance();

				machine.initialise(sms);
								
				result( "Completion Transitions: " + ( machine.isComplete(sms) ? "passed" : "failed" ) );
			}

			function shallowTest()
			{
                var machine = new fsm.StateMachine( "history" );
    
                var initial = new fsm.PseudoState( "initial", machine, fsm.PseudoStateKind.Initial);
                var shallow = new fsm.State( "shallow", machine );
                var deep = new fsm.State( "deep", machine );
                var end = new fsm.FinalState( "final", machine );
    
                var s1 = new fsm.State( "s1", shallow );
                var s2 = new fsm.State( "s2", shallow );
    
                initial.to(shallow);
                new fsm.PseudoState( "shallow", shallow, fsm.PseudoStateKind.ShallowHistory).to( s1 );
                s1.to(s2).when(function(c) { return c === "move";} );
                shallow.to(deep).when(function(c) { return c === "go deep";} );
                deep.to(shallow).when(function(c) { return c === "go shallow";} );
                s2.to(end).when(function(c) { return c === "end"; } );

                var sms = new fsm.StateMachineInstance();

				machine.initialise(sms);

				result( "Shallow History (1): " + machine.evaluate( "move", sms ) );
				result( "Shallow History (2): " + machine.evaluate( "go deep", sms ) );
				result( "Shallow History (3): " + machine.evaluate( "go shallow", sms ) );
				result( "Shallow History (4): " + machine.evaluate( "end", sms ) );
			
				result( "Shallow History: " + ( machine.isComplete( sms ) ? "passed" : "failed" ) );
			}

            function muximise1() {
                var main = new fsm.StateMachine( "mux" );

                var initial = new fsm.PseudoState("initial", main, fsm.PseudoStateKind.Initial);
                var ortho = new fsm.State("ortho", main);
                var simple = new fsm.State("simple", main);
                var final = new fsm.FinalState("final", main);

                var r1 = new fsm.Region("r1", ortho);
                var r2 = new fsm.Region("r2", ortho);

                var i1 = new fsm.PseudoState("initial", r1, fsm.PseudoStateKind.ShallowHistory);
                var i2 = new fsm.PseudoState("initial", r2, fsm.PseudoStateKind.ShallowHistory);

                var s1 = new fsm.State("s1", r1);
                var s2 = new fsm.State("s2", r2);

                var f1 = new fsm.FinalState("f1", r1);
                var f2 = new fsm.FinalState("f2", r2);

                initial.to(ortho);

                i1.to(s1);
                i2.to(s2);

                ortho.to(final); // This should happen once all regions in ortho are complete?

                s1.to(f1).when(function(c) {
                    return c === "complete1";
                });

                s2.to(f2).when(function(c) {
                    return c === "complete2";
                });

                ortho.to(simple).when(function(c) {
                    return c === "jump";
                });

                simple.to(ortho).when(function(c) {
                    return c === "back";
                });
                
                var sms = new fsm.StateMachineInstance();				
				main.initialise(sms);

                main.evaluate("complete1", sms);
                main.evaluate("complete2", sms)
            
            	result("Muximuse test 1: " + (main.isComplete(sms) ? "passed" : "failed"));
            }
            
            function brice1 () {
                var main = new fsm.StateMachine("brice");
                var initial1 = new fsm.PseudoState("initial", main, fsm.PseudoStateKind.Initial);
                var myComposite1 = new fsm.State("composite1", main);
                var state3 = new fsm.State("state3", main);
                var initial2 = new fsm.PseudoState("initial", myComposite1, fsm.PseudoStateKind.Initial);
                var state1 = new fsm.State("state1", myComposite1);
                var state2 = new fsm.State("state2", myComposite1);
                
                initial1.to(myComposite1);
                initial2.to(state1);
                myComposite1.to(state3).when(function(c) { return c === "a";}).effect(function() { result("Brice test1: failed"); });
                state1.to(state2).when(function(c) { return c === "a";}).effect(function() { result("Brice test1: passed"); });
                
                var sms = new fsm.StateMachineInstance();	
				main.initialise(sms);

                main.evaluate("a", sms);
            }
            
            function p3pp3r() {
                var main = new fsm.StateMachine("p3pp3r");
                var initial = new fsm.PseudoState("initial", main, fsm.PseudoStateKind.Initial); 
                var state1 = new fsm.State("state1", main);
                var state2 = new fsm.State("state2", main);
                
                var regionA = new fsm.Region("regionA", state1);
                var initialA = new fsm.PseudoState("initialA", regionA, fsm.PseudoStateKind.Initial); 
                var state3 = new fsm.State("state3", regionA);
                var state8 = new fsm.State("state8", regionA);

                var regionB = new fsm.Region("regionB", state1);
                var initialB = new fsm.PseudoState("initialB", regionB, fsm.PseudoStateKind.Initial); 
                var state4 = new fsm.State("state4", regionB);
                var state5 = new fsm.State("state5", regionB);

                var regionBa = new fsm.Region("regionBa", state4);
                var initialBa = new fsm.PseudoState("initialBa", regionBa, fsm.PseudoStateKind.Initial); 
                var state6 = new fsm.State("state6", regionBa);

                var regionBb = new fsm.Region("regionBb", state4);
                var initialBb = new fsm.PseudoState("initialBb", regionBb, fsm.PseudoStateKind.Initial); 
                var state7 = new fsm.State("state7", regionBb);
                
                initial.to(state1);
                initialA.to(state3);
                initialB.to(state4);
                initialBa.to(state6);
                initialBb.to(state7);
                
                state3.to(state2).when(function (c) { return c === "event2"; }).effect(function () { result("p3pp3r test passed"); });
                state3.to(state8).when(function (c) { return c === "event1"; });
                
                state7.to(state5).when(function (c) { return c === "event2"; }).effect(function () { result("p3pp3r test also failed"); });
                state7.to(state5).when(function (c) { return c === "event1"; });
                
                var sms = new fsm.StateMachineInstance();
                main.initialise(sms);
                
                main.evaluate("event2", sms);
            }
            
			function run ()
			{
				compTest();
				shallowTest();
                muximise1();
                brice1();
                p3pp3r();
			}			
		</script>
	</head>
	<body onload="run()">
        <h1>state.js v5.2.0 tests</h1>
		<div id="results"/>
	</body>
</html>