/*
 * Finite state machine library
 * Copyright (c) 2014-5 Steelbreeze Limited
 * Licensed under the MIT and GPL v3 licences
 * http://www.steelbreeze.net/state.cs
 */
var fsm
!function(t){var e=function(){function t(t){this.name=t}return t.prototype.getParent=function(){},t.prototype.root=function(){return this.getParent().root()},t.prototype.ancestors=function(){return(this.getParent()?this.getParent().ancestors():[]).concat(this)},t.prototype.isActive=function(t){return this.getParent().isActive(t)},t.prototype.accept=function(){for(var t=[],e=2;e<arguments.length;e++)t[e-2]=arguments[e]},t.prototype.toString=function(){return this.qualifiedName},t.namespaceSeparator=".",t}()
t.Element=e}(fsm||(fsm={}))
var __extends=this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])
i.prototype=e.prototype,t.prototype=new i},fsm
!function(t){var e=function(e){function i(i,n){e.call(this,i),this.transitions=[],n instanceof t.Region?this.region=n:n instanceof t.State&&(this.region=n.defaultRegion()),this.region&&(this.region.vertices.push(this),this.region.root().clean=!1)}return __extends(i,e),i.prototype.getParent=function(){return this.region},i.prototype.isComplete=function(){},i.prototype.to=function(e){var i=new t.Transition(this,e)
return this.transitions.push(i),this.root().clean=!1,i},i}(t.Element)
t.Vertex=e}(fsm||(fsm={}))
var fsm
!function(t){var e=function(e){function i(t,i,n){e.call(this,t,i),this.kind=n,this.isInitial()&&(this.region.initial=this)}return __extends(i,e),i.prototype.isComplete=function(){return!0},i.prototype.isHistory=function(){return this.kind===t.PseudoStateKind.DeepHistory||this.kind===t.PseudoStateKind.ShallowHistory},i.prototype.isInitial=function(){return this.kind===t.PseudoStateKind.Initial||this.isHistory()},i.prototype.accept=function(t,e,i,n,r){return t.visitPseudoState(this,e,i,n,r)},i}(t.Vertex)
t.PseudoState=e}(fsm||(fsm={}))
var fsm
!function(t){!function(t){t[t.Initial=0]="Initial",t[t.ShallowHistory=1]="ShallowHistory",t[t.DeepHistory=2]="DeepHistory",t[t.Choice=3]="Choice",t[t.Junction=4]="Junction",t[t.Terminate=5]="Terminate"}(t.PseudoStateKind||(t.PseudoStateKind={}))
t.PseudoStateKind}(fsm||(fsm={}))
var fsm
!function(t){var e=function(t){function e(e,i){t.call(this,e),this.parent=i,this.vertices=[],i.regions.push(this),i.root().clean=!1}return __extends(e,t),e.prototype.getParent=function(){return this.parent},e.prototype.isComplete=function(t){return t.getCurrent(this).isFinal()},e.prototype.accept=function(t,e,i,n,r){return t.visitRegion(this,e,i,n,r)},e.defaultName="default",e}(t.Element)
t.Region=e}(fsm||(fsm={}))
var fsm
!function(t){var e=function(e){function i(t,i){e.call(this,t,i),this.exitBehavior=[],this.entryBehavior=[],this.regions=[]}return __extends(i,e),i.prototype.defaultRegion=function(){for(var e,i=0,n=this.regions.length;n>i;i++)this.regions[i].name===t.Region.defaultName&&(e=this.regions[i])
return e||(e=new t.Region(t.Region.defaultName,this)),e},i.prototype.isActive=function(t){return e.prototype.isActive.call(this,t)&&t.getCurrent(this.region)===this},i.prototype.isFinal=function(){return 0===this.transitions.length},i.prototype.isSimple=function(){return 0===this.regions.length},i.prototype.isComposite=function(){return this.regions.length>0},i.prototype.isOrthogonal=function(){return this.regions.length>1},i.prototype.isComplete=function(t){for(var e=0,i=this.regions.length;i>e;e++)if(this.regions[e].isComplete(t)===!1)return!1
return!0},i.prototype.exit=function(t){return this.exitBehavior.push(t),this.root().clean=!1,this},i.prototype.entry=function(t){return this.entryBehavior.push(t),this.root().clean=!1,this},i.prototype.accept=function(t,e,i,n,r){return t.visitState(this,e,i,n,r)},i}(t.Vertex)
t.State=e}(fsm||(fsm={}))
var fsm
!function(t){var e=function(t){function e(e,i){t.call(this,e,i)}return __extends(e,t),e.prototype.to=function(){throw"A FinalState cannot be the source of a transition."},e.prototype.accept=function(t,e){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n]
return t.visitFinalState(this,e,i)},e}(t.State)
t.FinalState=e}(fsm||(fsm={}))
var fsm
!function(t){var e=function(){function t(){}return t.prototype.visitElement=function(){},t.prototype.visitRegion=function(t,e,i,n,r){for(var o=this.visitElement(t,e,i,n,r),s=0,a=t.vertices.length;a>s;s++)t.vertices[s].accept(this,e,i,n,r)
return o},t.prototype.visitVertex=function(t,e,i,n,r){for(var o=this.visitElement(t,e,i,n,r),s=0,a=t.transitions.length;a>s;s++)t.transitions[s].accept(this,e,i,n,r)
return o},t.prototype.visitPseudoState=function(t,e,i,n,r){return this.visitVertex(t,e,i,n,r)},t.prototype.visitState=function(t,e,i,n,r){for(var o=this.visitVertex(t,e,i,n,r),s=0,a=t.regions.length;a>s;s++)t.regions[s].accept(this,e,i,n,r)
return o},t.prototype.visitFinalState=function(t,e,i,n,r){return this.visitState(t,e,i,n,r)},t.prototype.visitStateMachine=function(t,e,i,n,r){return this.visitState(t,e,i,n,r)},t.prototype.visitTransition=function(){},t}()
t.Visitor=e}(fsm||(fsm={}))
var fsm
!function(t){function e(t,e,i,n){void 0===n&&(n=!1)
for(var r=0,o=t.length;o>r;r++)t[r](e,i,n)}var i=function(t){function i(e){t.call(this,e,void 0),this.clean=!1}return __extends(i,t),i.prototype.root=function(){return this.region?this.region.root():this},i.prototype.isActive=function(e){return this.region?t.prototype.isActive.call(this,e):!0},i.prototype.initialiseModel=function(){this.accept(s.getInstance(),!1),this.clean=!0},i.prototype.initialise=function(t,i){void 0===i&&(i=!0),i&&this.clean===!1&&this.initialiseModel(),e(this.init,void 0,t)},i.prototype.evaluate=function(t,e,i){return void 0===i&&(i=!0),i&&this.clean===!1&&this.initialiseModel(),e.isTerminated?!1:this.accept(n.getInstance(),e,t)},i.prototype.accept=function(t,e,i,n,r){return t.visitStateMachine(this,e,i,n,r)},i}(t.State)
t.StateMachine=i
var n=function(i){function n(){i.apply(this,arguments)}return __extends(n,i),n.getInstance=function(){return n._instance||(n._instance=new n),n._instance},n.prototype.visitRegion=function(t,e,i){return e.getCurrent(t).accept(this,e,i)},n.prototype.visitPseudoState=function(i,n,r){var o
switch(i.kind){case t.PseudoStateKind.Initial:case t.PseudoStateKind.DeepHistory:case t.PseudoStateKind.ShallowHistory:if(1!==i.transitions.length)throw"Initial transition must have a single outbound transition from "+i
o=i.transitions[0]
break
case t.PseudoStateKind.Junction:for(var s,a,u=0,c=i.transitions.length;c>u;u++)if(i.transitions[u].guard===t.Transition.isElse){if(a)throw"Multiple outbound transitions evaluated true"
a=i.transitions[u]}else if(i.transitions[u].guard(r,n)){if(s)throw"Multiple outbound transitions evaluated true"
s=i.transitions[u]}o=s||a
break
case t.PseudoStateKind.Choice:for(var h=[],u=0,c=i.transitions.length;c>u;u++)if(i.transitions[u].guard===t.Transition.isElse){if(a)throw"Multiple outbound else transitions found at "+this+" for "+r
a=i.transitions[u]}else i.transitions[u].guard(r,n)&&h.push(i.transitions[u])
o=0!==h.length?h[Math.round((h.length-1)*Math.random())]:a}return o?(e(o.traverse,r,n),!0):!1},n.prototype.visitState=function(t,i,n){for(var r=!1,o=0,s=t.regions.length;s>o&&(!t.regions[o].accept(this,i,n)||(r=!0,t.isActive(i)));o++);if(!r){for(var a,o=0,s=t.transitions.length;s>o;o++)if(t.transitions[o].guard(n,i)){if(a)throw new Error("Multiple outbound transitions evaluated true")
a=t.transitions[o]}a&&(e(a.traverse,n,i),r=!0)}return r&&n!==t&&t.isComplete(i)&&this.visitState(t,i,t),r},n}(t.Visitor),r=function(){function t(){this.leave=[],this.beginEnter=[],this.endEnter=[],this.enter=[]}return t}(),o=function(e){function i(){e.apply(this,arguments)}return __extends(i,e),i.getInstance=function(){return i._instance||(i._instance=new i),i._instance},i.prototype.visitTransition=function(e,i){if(e.target)if(e.target.getParent()===e.source.getParent())e.traverse=i(e.source).leave.concat(e.transitionBehavior).concat(i(e.target).enter)
else{for(var n=e.source.ancestors(),r=e.target.ancestors(),o=n.length,s=r.length,a=0,u=Math.min(o,s);u>a&&n[a]===r[a];)a++
if(n[a]instanceof t.Region)throw"Transitions may not cross sibling orthogonal region boundaries"
for(e.traverse=i(o>a?n[a]:e.source).leave.slice(0),e.traverse=e.traverse.concat(e.transitionBehavior),a>=s&&(e.traverse=e.traverse.concat(i(e.target).beginEnter));s>a;){var c=r[a++],h=s>a?r[a]:void 0
if(e.traverse=e.traverse.concat(i(c).beginEnter),c instanceof t.State){var f=c
if(f.isOrthogonal())for(var p=0,v=f.regions.length;v>p;p++){var l=f.regions[p]
l!==h&&(e.traverse=e.traverse.concat(i(l).enter))}}}e.traverse=e.traverse.concat(i(e.target).endEnter)}else e.traverse=e.transitionBehavior},i}(t.Visitor),s=function(i){function s(){i.apply(this,arguments),this.behaviours={}}return __extends(s,i),s.getInstance=function(){return s._instance||(s._instance=new s),s._instance},s.prototype.behaviour=function(e){return e.qualifiedName||(e.qualifiedName=e.ancestors().map(function(t){return t.name}).join(t.Element.namespaceSeparator)),this.behaviours[e.qualifiedName]||(this.behaviours[e.qualifiedName]=new r)},s.prototype.visitElement=function(t){var e=this.behaviour(t)
e.enter=e.beginEnter.concat(e.endEnter)},s.prototype.visitRegion=function(i,n){for(var r=this,o=this.behaviour(i),s=0,a=i.vertices.length;a>s;s++)i.vertices[s].accept(this,n||i.initial&&i.initial.kind===t.PseudoStateKind.DeepHistory)
o.leave.push(function(t,n){e(r.behaviour(n.getCurrent(i)).leave,t,n)}),n||!i.initial||i.initial.isHistory()?o.endEnter.push(function(n,o,s){var a=i.initial;(s||i.initial.isHistory())&&(a=o.getCurrent(i)||i.initial),e(r.behaviour(a).enter,n,o,s||i.initial.kind===t.PseudoStateKind.DeepHistory)}):o.endEnter=o.endEnter.concat(this.behaviour(i.initial).enter),this.visitElement(i,n)},s.prototype.visitVertex=function(t,e){this.visitElement(t,e)
var i=this.behaviour(t)
i.endEnter.push(function(e,i){t.isComplete(i)&&t.accept(n.getInstance(),i,t)}),i.enter=i.beginEnter.concat(i.endEnter)},s.prototype.visitPseudoState=function(e,i){this.visitVertex(e,i),e.kind===t.PseudoStateKind.Terminate&&this.behaviour(e).enter.push(function(t,e){e.isTerminated=!0})},s.prototype.visitState=function(t,i){for(var n=this.behaviour(t),r=0,o=t.regions.length;o>r;r++){var s=t.regions[r],a=this.behaviour(s)
s.accept(this,i),n.leave.push(function(t,i){e(a.leave,t,i)}),n.endEnter=n.endEnter.concat(a.enter)}this.visitVertex(t,i),n.leave=n.leave.concat(t.exitBehavior),n.beginEnter=n.beginEnter.concat(t.entryBehavior),n.beginEnter.push(function(e,i){t.region&&i.setCurrent(t.region,t)}),n.enter=n.beginEnter.concat(n.endEnter)},s.prototype.visitStateMachine=function(t,e){var i=this
this.behaviours={},this.visitState(t,e),t.accept(o.getInstance(),function(t){return i.behaviour(t)}),t.init=this.behaviour(t).enter},s}(t.Visitor)}(fsm||(fsm={}))
var fsm
!function(t){var e=function(){function t(t){void 0===t&&(t="unnamed"),this.name=t,this.isTerminated=!1,this.last={}}return t.prototype.setCurrent=function(t,e){this.last[t.qualifiedName]=e},t.prototype.getCurrent=function(t){return this.last[t.qualifiedName]},t.prototype.toString=function(){return this.name},t}()
t.StateMachineInstance=e}(fsm||(fsm={}))
var fsm
!function(t){var e=function(){function t(t,e){var i=this
this.source=t,this.target=e,this.transitionBehavior=[],this.traverse=[],this.guard=function(t){return t===i.source}}return t.prototype["else"]=function(){return this.guard=t.isElse,this},t.prototype.when=function(t){return this.guard=t,this},t.prototype.effect=function(t){return this.transitionBehavior.push(t),this.source.root().clean=!1,this},t.prototype.accept=function(t,e,i,n,r){return t.visitTransition(this,e,i,n,r)},t.isElse=function(){return!1},t}()
t.Transition=e}(fsm||(fsm={}))
