/*
 * Finite state machine library
 * Copyright (c) 2014-5 Steelbreeze Limited
 * Licensed under the MIT and GPL v3 licences
 * http://www.steelbreeze.net/state.cs
 */
var fsm
!function(t){var e=function(){function t(t){this.name=t}return t.prototype.getParent=function(){},t.prototype.root=function(){return this.getParent().root()},t.prototype.ancestors=function(){return(this.getParent()?this.getParent().ancestors():[]).concat(this)},t.prototype.accept=function(){},t.prototype.toString=function(){return this.qualifiedName},t.namespaceSeparator=".",t}()
t.Element=e}(fsm||(fsm={}))
var __extends=this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])
n.prototype=e.prototype,t.prototype=new n},fsm
!function(t){var e=function(e){function n(n,i){e.call(this,n),this.transitions=[],i instanceof t.Region?this.region=i:i instanceof t.State&&(this.region=i.defaultRegion()),this.region&&(this.region.vertices.push(this),this.region.root().clean=!1)}return __extends(n,e),n.prototype.getParent=function(){return this.region},n.prototype.to=function(e){var n=new t.Transition(this,e)
return this.transitions.push(n),this.root().clean=!1,n},n}(t.Element)
t.Vertex=e}(fsm||(fsm={}))
var fsm
!function(t){var e=function(e){function n(t,n,i){e.call(this,t,n),this.kind=i,this.isInitial()&&(this.region.initial=this)}return __extends(n,e),n.prototype.isHistory=function(){return this.kind===t.PseudoStateKind.DeepHistory||this.kind===t.PseudoStateKind.ShallowHistory},n.prototype.isInitial=function(){return this.kind===t.PseudoStateKind.Initial||this.isHistory()},n.prototype.accept=function(t,e,n,i,r){return t.visitPseudoState(this,e,n,i,r)},n}(t.Vertex)
t.PseudoState=e}(fsm||(fsm={}))
var fsm
!function(t){!function(t){t[t.Initial=0]="Initial",t[t.ShallowHistory=1]="ShallowHistory",t[t.DeepHistory=2]="DeepHistory",t[t.Choice=3]="Choice",t[t.Junction=4]="Junction",t[t.Terminate=5]="Terminate"}(t.PseudoStateKind||(t.PseudoStateKind={}))
t.PseudoStateKind}(fsm||(fsm={}))
var fsm
!function(t){var e=function(t){function e(e,n){t.call(this,e),this.vertices=[],this.state=n,this.state.regions.push(this),this.state.root().clean=!1}return __extends(e,t),e.prototype.getParent=function(){return this.state},e.prototype.accept=function(t,e,n,i,r){return t.visitRegion(this,e,n,i,r)},e.defaultName="default",e}(t.Element)
t.Region=e}(fsm||(fsm={}))
var fsm
!function(t){var e=function(e){function n(t,n){e.call(this,t,n),this.exitBehavior=[],this.entryBehavior=[],this.regions=[]}return __extends(n,e),n.prototype.defaultRegion=function(){var e
return this.regions.forEach(function(n){n.name===t.Region.defaultName&&(e=n)}),e||(e=new t.Region(t.Region.defaultName,this)),e},n.prototype.isFinal=function(){return 0===this.transitions.length},n.prototype.isSimple=function(){return 0===this.regions.length},n.prototype.isComposite=function(){return this.regions.length>0},n.prototype.isOrthogonal=function(){return this.regions.length>1},n.prototype.exit=function(t){return this.exitBehavior.push(t),this.root().clean=!1,this},n.prototype.entry=function(t){return this.entryBehavior.push(t),this.root().clean=!1,this},n.prototype.accept=function(t,e,n,i,r){return t.visitState(this,e,n,i,r)},n}(t.Vertex)
t.State=e}(fsm||(fsm={}))
var fsm
!function(t){var e=function(t){function e(e,n){t.call(this,e,n)}return __extends(e,t),e.prototype.to=function(){throw"A FinalState cannot be the source of a transition."},e.prototype.accept=function(t,e,n,i,r){return t.visitFinalState(this,e,n,i,r)},e}(t.State)
t.FinalState=e}(fsm||(fsm={}))
var fsm
!function(t){var e=function(){function t(){}return t.prototype.visitElement=function(){},t.prototype.visitRegion=function(t,e,n,i,r){var o=this,s=this.visitElement(t,e,n,i,r)
return t.vertices.forEach(function(t){t.accept(o,e,n,i,r)}),s},t.prototype.visitVertex=function(t,e,n,i,r){var o=this,s=this.visitElement(t,e,n,i,r)
return t.transitions.forEach(function(t){t.accept(o,e,n,i,r)}),s},t.prototype.visitPseudoState=function(t,e,n,i,r){return this.visitVertex(t,e,n,i,r)},t.prototype.visitState=function(t,e,n,i,r){var o=this,s=this.visitVertex(t,e,n,i,r)
return t.regions.forEach(function(t){t.accept(o,e,n,i,r)}),s},t.prototype.visitFinalState=function(t,e,n,i,r){return this.visitState(t,e,n,i,r)},t.prototype.visitStateMachine=function(t,e,n,i,r){return this.visitState(t,e,n,i,r)},t.prototype.visitTransition=function(){},t}()
t.Visitor=e}(fsm||(fsm={}))
var fsm
!function(t){function e(t,e,n,i){void 0===i&&(i=!1),t.forEach(function(t){t(e,n,i)})}function n(t,e){return t.region?n(t.region.state,e)&&e.getCurrent(t.region)===t:!0}function i(e,n){return e instanceof t.State?e.regions.every(function(t){return n.getCurrent(t).isFinal()}):!0}var r=function(t){function n(e){t.call(this,e,void 0),this.clean=!1}return __extends(n,t),n.prototype.root=function(){return this.region?this.region.root():this},n.prototype.initialiseModel=function(){this.accept(u.getInstance(),!1),this.clean=!0},n.prototype.initialise=function(t,n){void 0===n&&(n=!0),n&&this.clean===!1&&this.initialiseModel(),e(this.onInitialise,void 0,t)},n.prototype.evaluate=function(t,e,n){return void 0===n&&(n=!0),n&&this.clean===!1&&this.initialiseModel(),e.isTerminated?!1:this.accept(s.getInstance(),e,t)},n.prototype.isComplete=function(t){return i(this,t)},n.prototype.accept=function(t,e,n,i,r){return t.visitStateMachine(this,e,n,i,r)},n}(t.State)
t.StateMachine=r
var o=function(){function t(){this.leave=[],this.beginEnter=[],this.endEnter=[],this.enter=[]}return t}(),s=function(r){function o(){r.apply(this,arguments)}return __extends(o,r),o.getInstance=function(){return o._instance||(o._instance=new o),o._instance},o.prototype.visitRegion=function(t,e,n){return e.getCurrent(t).accept(this,e,n)},o.prototype.visitPseudoState=function(n,i,r){var o,s=this
switch(n.kind){case t.PseudoStateKind.Initial:case t.PseudoStateKind.DeepHistory:case t.PseudoStateKind.ShallowHistory:if(1!==n.transitions.length)throw"Initial transition must have a single outbound transition from "+n
o=n.transitions[0]
break
case t.PseudoStateKind.Junction:var a,u
n.transitions.forEach(function(e){if(e.guard===t.Transition.isElse){if(u)throw"Multiple outbound transitions evaluated true"
u=e}else if(e.guard(r,i)){if(a)throw"Multiple outbound transitions evaluated true"
a=e}}),o=a||u
break
case t.PseudoStateKind.Choice:var c=[]
n.transitions.forEach(function(e){if(e.guard===t.Transition.isElse){if(u)throw"Multiple outbound else transitions found at "+s+" for "+r
u=e}else e.guard(r,i)&&c.push(e)}),o=0!==c.length?c[Math.round((c.length-1)*Math.random())]:u}return o?(e(o.traverse,r,i),!0):!1},o.prototype.visitState=function(t,r,o){for(var s=!1,a=0,u=t.regions.length;u>a&&(!t.regions[a].accept(this,r,o)||(s=!0,n(t,r)));a++);if(!s){var c
t.transitions.forEach(function(t){if(t.guard(o,r)){if(c)throw new Error("Multiple outbound transitions evaluated true")
c=t}}),c&&(e(c.traverse,o,r),s=!0)}return s&&o!==t&&i(t,r)&&this.visitState(t,r,t),s},o}(t.Visitor),a=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.getInstance=function(){return n._instance||(n._instance=new n),n._instance},n.prototype.visitTransition=function(e,n){if(e.target)if(e.target.getParent()===e.source.getParent())e.traverse=n(e.source).leave.concat(e.transitionBehavior).concat(n(e.target).enter)
else{for(var i=e.source.ancestors(),r=e.target.ancestors(),o=i.length,s=r.length,a=0,u=Math.min(o,s);u>a&&i[a]===r[a];)a++
if(i[a]instanceof t.Region)throw"Transitions may not cross sibling orthogonal region boundaries"
for(e.traverse=n(o>a?i[a]:e.source).leave.slice(0),e.traverse=e.traverse.concat(e.transitionBehavior),a>=s&&(e.traverse=e.traverse.concat(n(e.target).beginEnter));s>a;){var c=r[a++],h=s>a?r[a]:void 0
if(e.traverse=e.traverse.concat(n(c).beginEnter),c instanceof t.State){var f=c
f.isOrthogonal()&&f.regions.forEach(function(t){t!==h&&(e.traverse=e.traverse.concat(n(t).enter))})}}e.traverse=e.traverse.concat(n(e.target).endEnter)}else e.traverse=e.transitionBehavior},n}(t.Visitor),u=function(n){function r(){n.apply(this,arguments),this.behaviours={}}return __extends(r,n),r.getInstance=function(){return r._instance||(r._instance=new r),r._instance},r.prototype.behaviour=function(e){return e.qualifiedName||(e.qualifiedName=e.ancestors().map(function(t){return t.name}).join(t.Element.namespaceSeparator)),this.behaviours[e.qualifiedName]||(this.behaviours[e.qualifiedName]=new o)},r.prototype.visitElement=function(t){var e=this.behaviour(t)
e.enter=e.beginEnter.concat(e.endEnter)},r.prototype.visitRegion=function(n,i){var r=this,o=this.behaviour(n)
n.vertices.forEach(function(e){e.accept(r,i||n.initial&&n.initial.kind===t.PseudoStateKind.DeepHistory)}),o.leave.push(function(t,i){e(r.behaviour(i.getCurrent(n)).leave,t,i)}),i||!n.initial||n.initial.isHistory()?o.endEnter.push(function(i,o,s){var a=n.initial;(s||n.initial.isHistory())&&(a=o.getCurrent(n)||n.initial),e(r.behaviour(a).enter,i,o,s||n.initial.kind===t.PseudoStateKind.DeepHistory)}):o.endEnter=o.endEnter.concat(this.behaviour(n.initial).enter),this.visitElement(n,i)},r.prototype.visitVertex=function(t,e){this.visitElement(t,e)
var n=this.behaviour(t)
n.endEnter.push(function(e,n){i(t,n)&&t.accept(s.getInstance(),n,t)}),n.enter=n.beginEnter.concat(n.endEnter)},r.prototype.visitPseudoState=function(e,n){this.visitVertex(e,n),e.kind===t.PseudoStateKind.Terminate&&this.behaviour(e).enter.push(function(t,e){e.isTerminated=!0})},r.prototype.visitState=function(t,n){var i=this,r=this.behaviour(t)
t.regions.forEach(function(t){var o=i.behaviour(t)
t.accept(i,n),r.leave.push(function(t,n){e(o.leave,t,n)}),r.endEnter=r.endEnter.concat(o.enter)}),this.visitVertex(t,n),r.leave=r.leave.concat(t.exitBehavior),r.beginEnter=r.beginEnter.concat(t.entryBehavior),r.beginEnter.push(function(e,n){t.region&&n.setCurrent(t.region,t)}),r.enter=r.beginEnter.concat(r.endEnter)},r.prototype.visitStateMachine=function(t,e){var n=this
this.behaviours={},this.visitState(t,e),t.accept(a.getInstance(),function(t){return n.behaviour(t)}),t.onInitialise=this.behaviour(t).enter},r}(t.Visitor)}(fsm||(fsm={}))
var fsm
!function(t){var e=function(){function t(t){void 0===t&&(t="unnamed"),this.name=t,this.isTerminated=!1,this.last={}}return t.prototype.setCurrent=function(t,e){this.last[t.qualifiedName]=e},t.prototype.getCurrent=function(t){return this.last[t.qualifiedName]},t.prototype.toString=function(){return this.name},t}()
t.StateMachineInstance=e}(fsm||(fsm={}))
var fsm
!function(t){var e=function(){function t(t,e){var n=this
this.source=t,this.target=e,this.transitionBehavior=[],this.traverse=[],this.guard=function(t){return t===n.source}}return t.prototype["else"]=function(){return this.guard=t.isElse,this},t.prototype.when=function(t){return this.guard=t,this},t.prototype.effect=function(t){return this.transitionBehavior.push(t),this.source.root().clean=!1,this},t.prototype.accept=function(t,e,n,i,r){return t.visitTransition(this,e,n,i,r)},t.isElse=function(){return!1},t}()
t.Transition=e}(fsm||(fsm={}))
