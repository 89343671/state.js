!function t(e,n,i){function r(s,a){if(!n[s]){if(!e[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(o)return o(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var h=n[s]={exports:{}};e[s][0].call(h.exports,function(t){var n=e[s][1][t];return r(n?n:t)},h,h.exports,t,e,n,i)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s]);return r}({1:[function(t,e,n){"use strict";function i(t){var e=n.logger;return n.logger=t,e}function r(t){var e=n.random;return n.random=t,e}function o(t){var e=n.internalTransitionsTriggerCompletion;return n.internalTransitionsTriggerCompletion=t,e}function s(t,e,n,i){for(var r=0,o=t;r<o.length;r++){var s=o[r];s(e,n,i)}}function a(t){return t.outgoing.filter(function(t){return t.guard===S.Else})[0]}function c(t,e,i){var r=t.outgoing.filter(function(t){return t.guard(i,e)});return t.kind===g.Choice?0!==r.length?r[n.random(r.length)]:a(t):(r.length>1&&n.logger.error("Multiple outbound transition guards returned true at "+t+" for "+i),r[0]||a(t))}function u(t,e,i){var r=!1;if(i!==t&&t.children.every(function(n){var o=e.getLastKnownState(n);return!o||!u(o,e,i)||(r=!0,t.isActive(e))}),t instanceof m)if(r)i!==t&&t.isComplete(e)&&u(t,e,t);else{var o=t.outgoing.filter(function(t){return t.guard(i,e)});1===o.length?(h(o[0],e,i),r=!0):o.length>1&&n.logger.error(t+": multiple outbound transitions evaluated true for message "+i)}return r}function h(t,e,n){for(var i=t.onTraverse.slice(),r=t;r.target&&r.target instanceof A&&r.target.kind===g.Junction;)r=c(r.target,e,n),i=i.concat(r.onTraverse);s(i,n,e,!1),r.target&&(r.target instanceof A&&r.target.kind===g.Choice?h(c(r.target,e,n),e,n):r.target instanceof m&&r.target.isComplete(e)&&u(r.target,e,r.target))}var l=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();n.__esModule=!0;var p=t("./tree");n.logger={log:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n]},error:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];throw t}},n.setLogger=i,n.random=function(t){return Math.floor(Math.random()*t)},n.setRandom=r,n.internalTransitionsTriggerCompletion=!1,n.setInternalTransitionsTriggerCompletion=o;var g;!function(t){t[t.Choice=0]="Choice",t[t.DeepHistory=1]="DeepHistory",t[t.Initial=2]="Initial",t[t.Junction=3]="Junction",t[t.ShallowHistory=4]="ShallowHistory"}(g=n.PseudoStateKind||(n.PseudoStateKind={}));var f;!function(t){t[t.External=0]="External",t[t.Internal=1]="Internal",t[t.Local=2]="Local"}(f=n.TransitionKind||(n.TransitionKind={}));var v=function(){function t(e,n){this.name=e,this.parent=n,this.children=new Array,this.qualifiedName=n?n.toString()+t.namespaceSeparator+e:e}return t.prototype.getRoot=function(){return this.parent.getRoot()},t.prototype.isActive=function(t){return this.parent.isActive(t)},t.prototype.accept=function(t,e){t.visitElement(this,e)},t.prototype.toString=function(){return this.qualifiedName},t}();v.namespaceSeparator=".",n.Element=v;var d=function(t){function e(e,n){var i=t.call(this,e,n)||this;return i.parent.children.push(i),i.getRoot().clean=!1,i}return l(e,t),e.prototype.isComplete=function(t){var e=t.getLastKnownState(this);return void 0!==e&&e.isFinal()},e.prototype.accept=function(t,e){t.visitRegion(this,e)},e}(v);d.defaultName="default",n.Region=d;var y=function(t){function e(e,n){var i=t.call(this,e,n instanceof d?n:m.defaultRegion(n))||this;return i.outgoing=new Array,i.incoming=new Array,i.parent.children.push(i),i.getRoot().clean=!1,i}return l(e,t),e.prototype.to=function(t,e){return void 0===e&&(e=f.External),new S(this,t,e)},e.prototype.accept=function(t,e){t.visitVertex(this,e)},e}(v);n.Vertex=y;var A=function(t){function e(e,n,i){void 0===i&&(i=g.Initial);var r=t.call(this,e,n)||this;return r.kind=i,r}return l(e,t),e.prototype.isHistory=function(){return this.kind===g.DeepHistory||this.kind===g.ShallowHistory},e.prototype.isInitial=function(){return this.kind===g.Initial||this.isHistory()},e.prototype.accept=function(t,e){t.visitPseudoState(this,e)},e}(y);n.PseudoState=A;var m=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.entryBehavior=new Array,e.exitBehavior=new Array,e}return l(e,t),e.defaultRegion=function(t){for(var e=0,n=t.children;e<n.length;e++){var i=n[e];if(i.name===d.defaultName)return i}return new d(d.defaultName,t)},e.prototype.isFinal=function(){return 0===this.outgoing.length},e.prototype.isSimple=function(){return 0===this.children.length},e.prototype.isComposite=function(){return this.children.length>0},e.prototype.isOrthogonal=function(){return this.children.length>1},e.prototype.isActive=function(e){return t.prototype.isActive.call(this,e)&&e.getLastKnownState(this.parent)===this},e.prototype.isComplete=function(t){return this.children.every(function(e){return e.isComplete(t)})},e.prototype.exit=function(t){return this.exitBehavior.push(t),this.getRoot().clean=!1,this},e.prototype.entry=function(t){return this.entryBehavior.push(t),this.getRoot().clean=!1,this},e.prototype.accept=function(t,e){t.visitState(this,e)},e}(y);n.State=m;var E=function(){function t(t){this.name=t,this.children=new Array,this.clean=!1,this.onInitialise=new Array,this.parent=void 0}return t.prototype.getRoot=function(){return this},t.prototype.accept=function(t,e){t.visitStateMachine(this,e)},t.prototype.isActive=function(t){return!0},t.prototype.isComplete=function(t){return this.children.every(function(e){return e.isComplete(t)})},t.prototype.initialise=function(t,e){void 0===e&&(e=!0),t?(e&&this.clean===!1&&this.initialise(),n.logger.log("initialise "+t),s(this.onInitialise,void 0,t,!1)):(n.logger.log("initialise "+this),this.accept(new x),this.clean=!0)},t.prototype.evaluate=function(t,e,i){return void 0===i&&(i=!0),i&&this.clean===!1&&this.initialise(),n.logger.log(t+" evaluate message: "+e),u(this,t,e)},t.prototype.toString=function(){return this.name},t}();n.StateMachine=E;var S=function(){function t(t,e,n){void 0===n&&(n=f.External);var i=this;this.source=t,this.target=e,this.kind=n,this.effectBehavior=new Array,this.onTraverse=new Array,this.guard=t instanceof A?function(){return!0}:function(t){return t===i.source},this.source.outgoing.push(this),this.source.getRoot().clean=!1,this.target?this.target.incoming.push(this):this.kind=f.Internal}return t.prototype.else=function(){return this.guard=t.Else,this},t.prototype.when=function(t){return this.guard=t,this},t.prototype.effect=function(t){return this.effectBehavior.push(t),this.source.getRoot().clean=!1,this},t.prototype.accept=function(t,e){t.visitTransition(this,e)},t.prototype.toString=function(){return f[this.kind]+"("+(this.kind===f.Internal?this.source:this.source+" -> "+this.target)+")"},t}();S.Else=function(t,e){return!1},n.Transition=S;var w=function(){function t(){}return t.prototype.visitElement=function(t,e){},t.prototype.visitRegion=function(t,e){for(var n=0,i=t.children;n<i.length;n++){var r=i[n];r.accept(this,e)}this.visitElement(t,e)},t.prototype.visitVertex=function(t,e){for(var n=0,i=t.outgoing;n<i.length;n++){var r=i[n];r.accept(this,e)}this.visitElement(t,e)},t.prototype.visitPseudoState=function(t,e){this.visitVertex(t,e)},t.prototype.visitState=function(t,e){for(var n=0,i=t.children;n<i.length;n++){var r=i[n];r.accept(this,e)}this.visitVertex(t,e)},t.prototype.visitStateMachine=function(t,e){for(var n=0,i=t.children;n<i.length;n++){var r=i[n];r.accept(this,e)}this.visitElement(t,e)},t.prototype.visitTransition=function(t,e){},t}();n.Visitor=w;var T=function(){function t(t){this.name=t,this.current={},this.activeStateConfiguration={}}return t.prototype.setCurrent=function(t,e){this.current[t.qualifiedName]=e,e instanceof m&&(this.activeStateConfiguration[t.qualifiedName]=e)},t.prototype.getCurrent=function(t){return this.current[t.qualifiedName]},t.prototype.getLastKnownState=function(t){return this.activeStateConfiguration[t.qualifiedName]},t.prototype.toString=function(){return this.name},t}();n.DictionaryInstance=T;var C=function(){function t(){this.leave=new Array,this.beginEnter=new Array,this.endEnter=new Array}return t}(),x=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.elementActions={},e.transitions=new Array,e}return l(e,t),e.prototype.getActions=function(t){return this.elementActions[t.toString()]||(this.elementActions[t.toString()]=new C)},e.prototype.visitElement=function(t,e){this.getActions(t).leave.push(function(e,i){return n.logger.log(i+" leave "+t)}),this.getActions(t).beginEnter.push(function(e,i){return n.logger.log(i+" enter "+t)})},e.prototype.visitRegion=function(e,n){var i=this,r=e.children.reduce(function(t,e){return e instanceof A&&e.isInitial()&&(void 0===t||t.isHistory())?e:t},void 0);this.getActions(e).leave.push(function(t,n){var r=n.getCurrent(e);r&&s(i.getActions(r).leave,t,n,!1)}),t.prototype.visitRegion.call(this,e,n||r&&r.kind===g.DeepHistory),n||!r||r.isHistory()?this.getActions(e).endEnter.push(function(t,n,o){var a=i.getActions(o||r.isHistory()?n.getLastKnownState(e)||r:r),c=o||r.kind===g.DeepHistory;s(a.beginEnter,t,n,c),s(a.endEnter,t,n,c)}):this.getActions(e).endEnter=this.getActions(e).endEnter.concat(this.getActions(r).beginEnter,this.getActions(r).endEnter)},e.prototype.visitVertex=function(e,n){t.prototype.visitVertex.call(this,e,n),this.getActions(e).beginEnter.push(function(t,n){n.setCurrent(e.parent,e)})},e.prototype.visitPseudoState=function(e,n){var i=this;t.prototype.visitPseudoState.call(this,e,n),e.isInitial()&&this.getActions(e).endEnter.push(function(t,n,r){if(n.getLastKnownState(e.parent)){s(i.getActions(e).leave,t,n,!1);var o=n.getLastKnownState(e.parent);o&&(s(i.getActions(o).beginEnter,t,n,r||e.kind===g.DeepHistory),s(i.getActions(o).endEnter,t,n,r||e.kind===g.DeepHistory))}else h(e.outgoing[0],n)})},e.prototype.visitState=function(t,e){for(var n=0,i=t.children;n<i.length;n++){var r=i[n];r.accept(this,e),this.getActions(t).leave=this.getActions(t).leave.concat(this.getActions(r).leave),this.getActions(t).endEnter=this.getActions(t).endEnter.concat(this.getActions(r).beginEnter,this.getActions(r).endEnter)}this.visitVertex(t,e),this.getActions(t).leave=this.getActions(t).leave.concat(t.exitBehavior),this.getActions(t).beginEnter=this.getActions(t).beginEnter.concat(t.entryBehavior)},e.prototype.visitStateMachine=function(e,n){t.prototype.visitStateMachine.call(this,e,n);for(var i=0,r=this.transitions;i<r.length;i++){var o=r[i];switch(o.kind){case f.Internal:this.visitInternalTransition(o);break;case f.Local:this.visitLocalTransition(o);break;case f.External:this.visitExternalTransition(o)}}for(var s=0,a=e.children;s<a.length;s++){var c=a[s];e.onInitialise=e.onInitialise.concat(this.getActions(c).beginEnter,this.getActions(c).endEnter)}},e.prototype.visitTransition=function(e,n){t.prototype.visitTransition.call(this,e,n),this.transitions.push(e)},e.prototype.visitInternalTransition=function(t){t.onTraverse=t.onTraverse.concat(t.effectBehavior),n.internalTransitionsTriggerCompletion&&t.onTraverse.push(function(e,n){t.source instanceof m&&t.source.isComplete(n)&&u(t.source,n,t.source)})},e.prototype.visitLocalTransition=function(t){var e=this;t.onTraverse.push(function(n,i,r){for(var o=p.Ancestors(t.target),a=0;o[a].isActive(i);)a++;if(o[a]instanceof d)throw"Need to implement Region logic";var c=o[a],u=i.getCurrent(c.parent);for(s(e.getActions(u).leave,n,i,!1),s(t.effectBehavior,n,i,!1);a<o.length;)s(e.getActions(o[a++]).beginEnter,n,i,!1);s(e.getActions(t.target).endEnter,n,i,!1)})},e.prototype.visitExternalTransition=function(t){var e=p.Ancestors(t.source),n=p.Ancestors(t.target);console.log("source = "+t.source),console.log("target = "+t.target),console.log("sourceAncestors.length = "+e.length),console.log("targetAncestors.length = "+n.length);var i=p.LCA(e,n);for(e[i]instanceof d&&(i+=1),console.log("LCA = "+i),t.onTraverse=t.onTraverse.concat(this.getActions(e[i]).leave,t.effectBehavior);i<n.length;)t.onTraverse=t.onTraverse.concat(this.getActions(n[i++]).beginEnter);t.onTraverse=t.onTraverse.concat(this.getActions(t.target).endEnter)},e}(w)},{"./tree":2}],2:[function(t,e,n){"use strict";function i(t){var e=t.parent?i(t.parent):new Array;return e.push(t),e}function r(t,e){for(var n=0;n<t.length&&n<e.length&&t[n]===e[n];)n++;return n-1}n.__esModule=!0,n.Ancestors=i,n.LCA=r},{}],3:[function(t,e,n){window[((document.currentScript||document.getElementsByTagName("script")[scripts.length-1]).attributes.target||{textContent:"fsm"}).textContent]=t("../lib/node/state.js")},{"../lib/node/state.js":1}]},{},[3]);
