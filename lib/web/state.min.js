!function t(e,n,i){function r(s,a){if(!n[s]){if(!e[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var h=n[s]={exports:{}};e[s][0].call(h.exports,function(t){var n=e[s][1][t];return r(n?n:t)},h,h.exports,t,e,n,i)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s]);return r}({1:[function(t,e,n){"use strict";function i(t){n.console=t}function r(t){n.random=t}function o(t){n.internalTransitionsTriggerCompletion=t}function s(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var i=0,r=e;i<r.length;i++)for(var o=r[i],s=0,a=o;s<a.length;s++){var u=a[s];t.push(u)}}function a(t,e,n,i){for(var r=0,o=t;r<o.length;r++){var s=o[r];s(e,n,i)}}var u=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};n.console={log:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n]},warn:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n]},error:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];throw t}},n.setConsole=i,n.random=function(t){return Math.floor(Math.random()*t)},n.setRandom=r,n.internalTransitionsTriggerCompletion=!1,n.setInternalTransitionsTriggerCompletion=o;var c=function(t,e){return!1};!function(t){t[t.Choice=0]="Choice",t[t.DeepHistory=1]="DeepHistory",t[t.Initial=2]="Initial",t[t.Junction=3]="Junction",t[t.ShallowHistory=4]="ShallowHistory"}(n.PseudoStateKind||(n.PseudoStateKind={}));var h=n.PseudoStateKind;!function(t){t[t.External=0]="External",t[t.Internal=1]="Internal",t[t.Local=2]="Local"}(n.TransitionKind||(n.TransitionKind={}));var p=n.TransitionKind,l=function(){function t(e,n){this.name=e,this.parent=n,this.qualifiedName=n?n.toString()+t.namespaceSeparator+e:e}return t.prototype.getAncestors=function(){return this.parent.getAncestors().concat(this)},t.prototype.getRoot=function(){return this.parent.getRoot()},t.prototype.isActive=function(t){return this.parent.isActive(t)},t.prototype.accept=function(t,e){t.visitElement(this,e)},t.prototype.toString=function(){return this.qualifiedName},t.namespaceSeparator=".",t}();n.NamedElement=l;var g=function(t){function e(e,n){t.call(this,e,n),this.vertices=new Array,this.parent.regions.push(this),this.getRoot().clean=!1}return u(e,t),e.prototype.isComplete=function(t){var e=t.getCurrent(this);return void 0!==e&&e.isFinal()},e.prototype.accept=function(t,e){t.visitRegion(this,e)},e.defaultName="default",e}(l);n.Region=g;var f=function(t){function e(e,n){t.call(this,e,n instanceof g?n:n.getDefaultRegion()),this.outgoing=new Array,this.incoming=new Array,this.parent.vertices.push(this),this.getRoot().clean=!1}return u(e,t),e.prototype.to=function(t,e){return void 0===e&&(e=p.External),new A(this,t,e)},e.prototype.accept=function(t,e){t.visitVertex(this,e)},e}(l);n.Vertex=f;var v=function(t){function e(e,n,i){void 0===i&&(i=h.Initial),t.call(this,e,n),this.kind=i}return u(e,t),e.prototype.isHistory=function(){return this.kind===h.DeepHistory||this.kind===h.ShallowHistory},e.prototype.isInitial=function(){return this.kind===h.Initial||this.isHistory()},e.prototype.selectTransition=function(t,e){var i=this.outgoing.filter(function(n){return n.guard(e,t)});return this.kind===h.Choice?0!==i.length?i[n.random(i.length)]:this.findElse():(i.length>1&&n.console.error("Multiple outbound transition guards returned true at "+this+" for "+e),i[0]||this.findElse())},e.prototype.findElse=function(){return this.outgoing.filter(function(t){return t.guard===c})[0]},e.prototype.accept=function(t,e){t.visitPseudoState(this,e)},e}(f);n.PseudoState=v;var y=function(t){function e(e,n){t.call(this,e,n),this.regions=new Array,this.entryBehavior=new Array,this.exitBehavior=new Array}return u(e,t),e.prototype.getDefaultRegion=function(){return this.defaultRegion||(this.defaultRegion=new g(g.defaultName,this))},e.prototype.isFinal=function(){return 0===this.outgoing.length},e.prototype.isSimple=function(){return 0===this.regions.length},e.prototype.isComposite=function(){return this.regions.length>0},e.prototype.isOrthogonal=function(){return this.regions.length>1},e.prototype.exit=function(t){return this.exitBehavior.push(t),this.getRoot().clean=!1,this},e.prototype.entry=function(t){return this.entryBehavior.push(t),this.getRoot().clean=!1,this},e.prototype.isActive=function(e){return t.prototype.isActive.call(this,e)&&e.getCurrent(this.parent)===this},e.prototype.isComplete=function(t){return this.regions.every(function(e){return e.isComplete(t)})},e.prototype.evaluateState=function(t,e){var i=this,r=!1;if(e!==this&&this.regions.every(function(n){var o=t.getCurrent(n);return!o||!o.evaluateState(t,e)||(r=!0,i.isActive(t))}),r)e!==this&&this.isComplete(t)&&this.evaluateState(t,this);else{var o=this.outgoing.filter(function(n){return n.guard(e,t)});1===o.length?r=o[0].traverse(t,e):o.length>1&&n.console.error(this+": multiple outbound transitions evaluated true for message "+e)}return r},e.prototype.accept=function(t,e){t.visitState(this,e)},e}(f);n.State=y;var d=function(){function t(t){this.name=t,this.regions=new Array,this.defaultRegion=void 0,this.clean=!1,this.onInitialise=new Array}return t.prototype.getDefaultRegion=function(){return this.defaultRegion||(this.defaultRegion=new g(g.defaultName,this))},t.prototype.getAncestors=function(){return[this]},t.prototype.getRoot=function(){return this},t.prototype.accept=function(t,e){t.visitStateMachine(this,e)},t.prototype.isActive=function(t){return!0},t.prototype.isComplete=function(t){return this.regions.every(function(e){return e.isComplete(t)})},t.prototype.initialise=function(t,e){void 0===e&&(e=!0),t?(e&&this.clean===!1&&this.initialise(),n.console.log("initialise "+t),a(this.onInitialise,void 0,t,!1)):(n.console.log("initialise "+this),this.accept(new S),this.clean=!0)},t.prototype.evaluate=function(t,e,i){return void 0===i&&(i=!0),i&&this.clean===!1&&this.initialise(),n.console.log(t+" evaluate message: "+e),this.evaluateState(t,e)},t.prototype.evaluateState=function(t,e){var n=this,i=!1;return this.regions.every(function(r){var o=t.getCurrent(r);return!o||!o.evaluateState(t,e)||(i=!0,n.isActive(t))}),i},t.prototype.toString=function(){return this.name},t}();n.StateMachine=d;var A=function(){function t(t,e,n){var i=this;void 0===n&&(n=p.External),this.source=t,this.target=e,this.kind=n,this.effectBehavior=new Array,this.onTraverse=new Array,this.guard=t instanceof v?function(){return!0}:function(t){return t===i.source},this.source.outgoing.push(this),this.source.getRoot().clean=!1,this.target?this.target.incoming.push(this):this.kind=p.Internal}return t.prototype.else=function(){return this.guard=c,this},t.prototype.when=function(t){return this.guard=t,this},t.prototype.effect=function(t){return this.effectBehavior.push(t),this.source.getRoot().clean=!1,this},t.prototype.traverse=function(t,e){for(var n=this.onTraverse.slice(0),i=this;i.target&&i.target instanceof v&&i.target.kind===h.Junction;)i=i.target.selectTransition(t,e),s(n,i.onTraverse);return a(n,e,t,!1),i.target&&(i.target instanceof v&&i.target.kind===h.Choice?i.target.selectTransition(t,e).traverse(t,e):i.target instanceof y&&i.target.isComplete(t)&&i.target.evaluateState(t,i.target)),!0},t.prototype.accept=function(t,e){t.visitTransition(this,e)},t.prototype.toString=function(){return p[this.kind]+"("+(this.kind===p.Internal?this.source:this.source+" -> "+this.target)+")"},t}();n.Transition=A;var m=function(){function t(){}return t.prototype.visitElement=function(t,e){},t.prototype.visitRegion=function(t,e){for(var n=0,i=t.vertices;n<i.length;n++){var r=i[n];r.accept(this,e)}this.visitElement(t,e)},t.prototype.visitVertex=function(t,e){for(var n=0,i=t.outgoing;n<i.length;n++){var r=i[n];r.accept(this,e)}this.visitElement(t,e)},t.prototype.visitPseudoState=function(t,e){this.visitVertex(t,e)},t.prototype.visitState=function(t,e){for(var n=0,i=t.regions;n<i.length;n++){var r=i[n];r.accept(this,e)}this.visitVertex(t,e)},t.prototype.visitStateMachine=function(t,e){for(var n=0,i=t.regions;n<i.length;n++){var r=i[n];r.accept(this,e)}this.visitElement(t,e)},t.prototype.visitTransition=function(t,e){},t}();n.Visitor=m;var E=function(){function t(t){this.name=t,this.activeStateConfiguration={}}return t.prototype.setCurrent=function(t,e){this.activeStateConfiguration[t.qualifiedName]=e},t.prototype.getCurrent=function(t){return this.activeStateConfiguration[t.qualifiedName]},t.prototype.toString=function(){return this.name},t}();n.DictionaryInstance=E;var S=function(t){function e(){t.apply(this,arguments),this.elementActions={},this.transitions=new Array}return u(e,t),e.prototype.getActions=function(t){return this.elementActions[t.toString()]||(this.elementActions[t.toString()]={leave:[],beginEnter:[],endEnter:[]})},e.prototype.visitElement=function(t,e){this.getActions(t).leave.push(function(e,i){return n.console.log(i+" leave "+t)}),this.getActions(t).beginEnter.push(function(e,i){return n.console.log(i+" enter "+t)})},e.prototype.visitRegion=function(e,n){var i=this,r=e.vertices.reduce(function(t,e){return e instanceof v&&e.isInitial()&&(void 0===t||t.isHistory())?e:t},void 0);t.prototype.visitRegion.call(this,e,n||r&&r.kind===h.DeepHistory),this.getActions(e).leave.push(function(t,n){var r=n.getCurrent(e);r&&a(i.getActions(r).leave,t,n,!1)}),n||!r||r.isHistory()?this.getActions(e).endEnter.push(function(t,n,o){var s=i.getActions(o||r.isHistory()?n.getCurrent(e)||r:r),u=o||r.kind===h.DeepHistory;a(s.beginEnter,t,n,u),a(s.endEnter,t,n,u)}):s(this.getActions(e).endEnter,this.getActions(r).beginEnter,this.getActions(r).endEnter)},e.prototype.visitPseudoState=function(e,n){var i=this;t.prototype.visitPseudoState.call(this,e,n),e.isInitial()&&this.getActions(e).endEnter.push(function(t,n,r){if(n.getCurrent(e.parent)){a(i.getActions(e).leave,t,n,!1);var o=n.getCurrent(e.parent);o&&(a(i.getActions(o).beginEnter,t,n,r||e.kind===h.DeepHistory),a(i.getActions(o).endEnter,t,n,r||e.kind===h.DeepHistory))}else e.outgoing[0].traverse(n)})},e.prototype.visitState=function(t,e){for(var n=0,i=t.regions;n<i.length;n++){var r=i[n];r.accept(this,e),s(this.getActions(t).leave,this.getActions(r).leave),s(this.getActions(t).endEnter,this.getActions(r).beginEnter,this.getActions(r).endEnter)}this.visitVertex(t,e),s(this.getActions(t).leave,t.exitBehavior),s(this.getActions(t).beginEnter,t.entryBehavior),this.getActions(t).beginEnter.push(function(e,n){n.setCurrent(t.parent,t)})},e.prototype.visitStateMachine=function(e,n){t.prototype.visitStateMachine.call(this,e,n);for(var i=0,r=this.transitions;i<r.length;i++){var o=r[i];switch(o.kind){case p.Internal:this.visitInternalTransition(o);break;case p.Local:this.visitLocalTransition(o);break;case p.External:this.visitExternalTransition(o)}}for(var a=0,u=e.regions;a<u.length;a++){var c=u[a];s(e.onInitialise,this.getActions(c).beginEnter,this.getActions(c).endEnter)}},e.prototype.visitTransition=function(e,n){t.prototype.visitTransition.call(this,e,n),this.transitions.push(e)},e.prototype.visitInternalTransition=function(t){s(t.onTraverse,t.effectBehavior),n.internalTransitionsTriggerCompletion&&t.onTraverse.push(function(e,n){t.source instanceof y&&t.source.isComplete(n)&&t.source.evaluateState(n,t.source)})},e.prototype.visitLocalTransition=function(t){var e=this;t.onTraverse.push(function(n,i){for(var r=t.target.getAncestors(),o=0;r[o].isActive(i);)o++;if(r[o]instanceof g)throw"Need to implement Region logic";var s=r[o],u=i.getCurrent(s.parent);for(a(e.getActions(u).leave,n,i,!1),a(t.effectBehavior,n,i,!1);o<r.length;)a(e.getActions(r[o++]).beginEnter,n,i,!1);a(e.getActions(t.target).endEnter,n,i,!1)})},e.prototype.visitExternalTransition=function(t){for(var e=t.source.getAncestors(),i=t.target.getAncestors(),r=Math.min(e.length,i.length)-1;e[r]!==i[r];)--r;for(n.console.log("LCA is "+e[r]),s(t.onTraverse,this.getActions(e[r]).leave,t.effectBehavior);r<i.length;)s(t.onTraverse,this.getActions(i[r++]).beginEnter);s(t.onTraverse,this.getActions(t.target).endEnter)},e}(m)},{}],2:[function(t,e,n){window[((document.currentScript||document.getElementsByTagName("script")[scripts.length-1]).attributes.target||{textContent:"fsm"}).textContent]=t("../lib/node/state.js")},{"../lib/node/state.js":1}]},{},[2]);
