!function t(e,n,i){function r(s,a){if(!n[s]){if(!e[s]){var u="function"==typeof require&&require
if(!a&&u)return u(s,!0)
if(o)return o(s,!0)
var h=new Error("Cannot find module '"+s+"'")
throw h.code="MODULE_NOT_FOUND",h}var c=n[s]={exports:{}}
e[s][0].call(c.exports,function(t){var n=e[s][1][t]
return r(n?n:t)},c,c.exports,t,e,n,i)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s])
return r}({1:[function(t,e,n){"use strict"
function i(t,e){return t.region?i(t.region.state,e)&&e.getCurrent(t.region)===t:!0}function r(t,e){return t instanceof y?e.getCurrent(t).isFinal():t.regions.every(function(t){return r(t,e)})}function o(t,e,i){void 0===i&&(i=!0),e?(i&&t.clean===!1&&o(t),n.console.log("initialise "+e),t.onInitialise.invoke(void 0,e)):(n.console.log("initialise "+t.name),t.accept(new H,!1),t.clean=!0)}function s(t,e,i,r){return void 0===r&&(r=!0),r&&t.clean===!1&&o(t),n.console.log(e+" evaluate "+i),e.isTerminated?!1:a(t,e,i)}function a(t,e,o){var s=!1
if(o!==t&&t.regions.every(function(n){return a(e.getCurrent(n),e,o)?(s=!0,i(t,e)):!0}),s)o!==t&&r(t,e)&&a(t,e,t)
else{var h=t.outgoing.filter(function(t){return t.guard(o,e)})
1===h.length?s=u(h[0],e,o):h.length>1&&n.console.error(t+": multiple outbound transitions evaluated true for message "+o)}return s}function u(t,e,n){for(var i=t,o=i.target,s=new f(i.onTraverse);o&&o instanceof b&&o.kind===v.Junction;)i=h(o,e,n),o=i.target,s.pushh(i.onTraverse)
return s.invoke(n,e),o&&(o instanceof b&&o.kind===v.Choice?u(h(o,e,n),e,n):o instanceof E&&r(o,e)&&a(o,e,o)),!0}function h(t,e,i){var r=t.outgoing.filter(function(t){return t.guard(i,e)})
return t.kind===v.Choice?0!==r.length?r[n.random(r.length)]:c(t):r.length>1?void n.console.error("Multiple outbound transition guards returned true at "+t+" for "+i):r[0]||c(t)}function c(t){return t.outgoing.filter(function(t){return t.guard===w.FalseGuard})[0]}function l(t){t.accept(new B)}var p=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])
t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}
!function(t){t[t.Initial=0]="Initial",t[t.ShallowHistory=1]="ShallowHistory",t[t.DeepHistory=2]="DeepHistory",t[t.Choice=3]="Choice",t[t.Junction=4]="Junction",t[t.Terminate=5]="Terminate"}(n.PseudoStateKind||(n.PseudoStateKind={}))
var v=n.PseudoStateKind
!function(t){t[t.Internal=0]="Internal",t[t.Local=1]="Local",t[t.External=2]="External"}(n.TransitionKind||(n.TransitionKind={}))
var g=n.TransitionKind,f=function(t){function e(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n]
t.call(this),this.apply(e)}return p(e,t),e.prototype.pushh=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e]
this.apply(t)},e.prototype.apply=function(t){for(var e=0,n=t;e<n.length;e++)for(var i=n[e],r=0,o=i;r<o.length;r++){var s=o[r]
this.push(s)}},e.prototype.invoke=function(t,e,n){void 0===n&&(n=!1)
for(var i=0,r=this;i<r.length;i++){var o=r[i]
o(t,e,n)}},e}(Array)
n.Actions=f
var d=function(){function t(e,n){this.name=e,this.qualifiedName=n?n.qualifiedName+t.namespaceSeparator+e:e}return t.prototype.toString=function(){return this.qualifiedName},t.namespaceSeparator=".",t}()
n.Element=d
var y=function(t){function e(e,n){t.call(this,e,n),this.vertices=new Array,this.state=n,this.state.regions.push(this),this.state.getRoot().clean=!1}return p(e,t),e.prototype.remove=function(){for(var t=0,e=this.vertices;t<e.length;t++){var i=e[t]
i.remove()}this.state.regions.splice(this.state.regions.indexOf(this),1),n.console.log("remove "+this),this.state.getRoot().clean=!1},e.prototype.getRoot=function(){return this.state.getRoot()},e.prototype.accept=function(t,e,n,i){return t.visitRegion(this,e,n,i)},e.defaultName="default",e}(d)
n.Region=y
var m=function(t){function e(e,n){t.call(this,e,E.parent(n)),this.outgoing=new Array,this.incoming=new Array,this.region=E.parent(n),this.region&&(this.region.vertices.push(this),this.region.getRoot().clean=!1)}return p(e,t),e.parent=function(t){return t instanceof E?t.defaultRegion():t},e.prototype.ancestry=function(){return(this.region?this.region.state.ancestry():new Array).concat(this)},e.prototype.getRoot=function(){return this.region.getRoot()},e.prototype.remove=function(){for(var t=0,e=this.outgoing;t<e.length;t++){var i=e[t]
i.remove()}for(var r=0,o=this.incoming;r<o.length;r++){var i=o[r]
i.remove()}this.region.vertices.splice(this.region.vertices.indexOf(this),1),n.console.log("remove "+this),this.region.getRoot().clean=!1},e.prototype.to=function(t,e){return void 0===e&&(e=g.External),new w(this,t,e)},e}(d)
n.Vertex=m
var b=function(t){function e(e,n,i){void 0===i&&(i=v.Initial),t.call(this,e,n),this.kind=i}return p(e,t),e.prototype.isHistory=function(){return this.kind===v.DeepHistory||this.kind===v.ShallowHistory},e.prototype.isInitial=function(){return this.kind===v.Initial||this.isHistory()},e.prototype.accept=function(t,e,n,i){return t.visitPseudoState(this,e,n,i)},e}(m)
n.PseudoState=b
var E=function(t){function e(e,n){t.call(this,e,n),this.exitBehavior=new f,this.entryBehavior=new f,this.regions=new Array}return p(e,t),e.prototype.defaultRegion=function(){return this.regions.reduce(function(t,e){return e.name===y.defaultName?e:t},void 0)||new y(y.defaultName,this)},e.prototype.isFinal=function(){return 0===this.outgoing.length},e.prototype.isSimple=function(){return 0===this.regions.length},e.prototype.isComposite=function(){return this.regions.length>0},e.prototype.isOrthogonal=function(){return this.regions.length>1},e.prototype.remove=function(){for(var e=0,n=this.regions;e<n.length;e++){var i=n[e]
i.remove()}t.prototype.remove.call(this)},e.prototype.exit=function(t){return this.exitBehavior.push(t),this.getRoot().clean=!1,this},e.prototype.entry=function(t){return this.entryBehavior.push(t),this.getRoot().clean=!1,this},e.prototype.accept=function(t,e,n,i){return t.visitState(this,e,n,i)},e}(m)
n.State=E
var S=function(t){function e(e,n){t.call(this,e,n)}return p(e,t),e.prototype.accept=function(t,e,n,i){return t.visitFinalState(this,e,n,i)},e}(E)
n.FinalState=S
var T=function(t){function e(e){t.call(this,e,void 0),this.clean=!1}return p(e,t),e.prototype.getRoot=function(){return this.region?this.region.getRoot():this},e.prototype.accept=function(t,e,n,i){return t.visitStateMachine(this,e,n,i)},e}(E)
n.StateMachine=T
var w=function(){function t(e,n,i){var r=this
void 0===i&&(i=g.External),this.transitionBehavior=new f,this.source=e,this.target=n,this.kind=n?i:g.Internal,this.guard=e instanceof b?t.TrueGuard:function(t){return t===r.source},this.source.outgoing.push(this),this.target&&this.target.incoming.push(this),this.source.getRoot().clean=!1}return t.prototype["else"]=function(){return this.guard=t.FalseGuard,this},t.prototype.when=function(t){return this.guard=t,this},t.prototype.effect=function(t){return this.transitionBehavior.push(t),this.source.getRoot().clean=!1,this},t.prototype.remove=function(){this.source.outgoing.splice(this.source.outgoing.indexOf(this),1),this.target&&this.target.incoming.splice(this.target.incoming.indexOf(this),1),n.console.log("remove "+this),this.source.getRoot().clean=!1},t.prototype.accept=function(t,e,n,i){return t.visitTransition(this,e,n,i)},t.prototype.toString=function(){return"[ "+(this.target?this.source+" -> "+this.target:this.source)+"]"},t.TrueGuard=function(){return!0},t.FalseGuard=function(){return!1},t}()
n.Transition=w
var k=function(){function t(t){void 0===t&&(t="unnamed"),this.last=[],this.isTerminated=!1,this.name=t}return t.prototype.setCurrent=function(t,e){this.last[t.qualifiedName]=e},t.prototype.getCurrent=function(t){return this.last[t.qualifiedName]},t.prototype.toString=function(){return this.name},t}()
n.StateMachineInstance=k
var x=function(){function t(){}return t.prototype.visitElement=function(){},t.prototype.visitRegion=function(t,e,n,i){for(var r=this.visitElement(t,e,n,i),o=0,s=t.vertices;o<s.length;o++){var a=s[o]
a.accept(this,e,n,i)}return r},t.prototype.visitVertex=function(t,e,n,i){for(var r=this.visitElement(t,e,n,i),o=0,s=t.outgoing;o<s.length;o++){var a=s[o]
a.accept(this,e,n,i)}return r},t.prototype.visitPseudoState=function(t,e,n,i){return this.visitVertex(t,e,n,i)},t.prototype.visitState=function(t,e,n,i){for(var r=this.visitVertex(t,e,n,i),o=0,s=t.regions;o<s.length;o++){var a=s[o]
a.accept(this,e,n,i)}return r},t.prototype.visitFinalState=function(t,e,n,i){return this.visitState(t,e,n,i)},t.prototype.visitStateMachine=function(t,e,n,i){return this.visitState(t,e,n,i)},t.prototype.visitTransition=function(){},t}()
n.Visitor=x,n.isActive=i,n.isComplete=r
var C=function(t){return Math.floor(Math.random()*t)}
n.random=C,n.initialise=o,n.evaluate=s
var R=function(){function t(){this.leave=new f,this.beginEnter=new f,this.endEnter=new f}return t.prototype.enter=function(){return new f(this.beginEnter,this.endEnter)},t}(),I=function(t){function e(){t.apply(this,arguments)}return p(e,t),e.prototype.visitTransition=function(t,e){switch(t.onTraverse=new f,t.kind){case g.Internal:this.visitInternalTransition(t,e)
break
case g.Local:this.visitLocalTransition(t,e)
break
case g.External:this.visitExternalTransition(t,e)}},e.prototype.visitInternalTransition=function(t){t.onTraverse.pushh(t.transitionBehavior),n.internalTransitionsTriggerCompletion&&t.onTraverse.push(function(e,n){var i=t.source
r(i,n)&&a(i,n,i)})},e.prototype.visitLocalTransition=function(t,e){var n=this
t.onTraverse.push(function(r,o){for(var s=t.target.ancestry(),a=0;i(s[a],o);)++a
for(e(o.getCurrent(s[a].region)).leave.invoke(r,o),t.transitionBehavior.invoke(r,o);a<s.length;)n.cascadeElementEntry(t,e,s[a++],s[a],function(t){return t.invoke(r,o)})
e(t.target).endEnter.invoke(r,o)})},e.prototype.visitExternalTransition=function(t,e){for(var n=t.source.ancestry(),i=t.target.ancestry(),r=Math.min(n.length,i.length)-1;n[r-1]!==i[r-1];)--r
for(t.onTraverse.pushh(e(n[r]).leave,t.transitionBehavior);r<i.length;)this.cascadeElementEntry(t,e,i[r++],i[r],function(e){return t.onTraverse.pushh(e)})
t.onTraverse.pushh(e(t.target).endEnter)},e.prototype.cascadeElementEntry=function(t,e,n,i,r){if(r(e(n).beginEnter),i&&n instanceof E)for(var o=0,s=n.regions;o<s.length;o++){var a=s[o]
r(e(a).beginEnter),a!==i.region&&r(e(a).endEnter)}},e}(x),H=function(t){function e(){t.apply(this,arguments),this.behaviors={}}return p(e,t),e.prototype.behavior=function(t){return this.behaviors[t.qualifiedName]||(this.behaviors[t.qualifiedName]=new R)},e.prototype.visitElement=function(t){n.console!==N&&(this.behavior(t).leave.push(function(e,i){return n.console.log(i+" enter "+t)}),this.behavior(t).beginEnter.push(function(e,i){return n.console.log(i+" enter "+t)}))},e.prototype.visitRegion=function(t,e){for(var n=this,i=t.vertices.reduce(function(t,e){return e instanceof b&&e.isInitial()?e:t},void 0),r=0,o=t.vertices;r<o.length;r++){var s=o[r]
s.accept(this,e||i&&i.kind===v.DeepHistory)}this.behavior(t).leave.push(function(e,i){return n.behavior(i.getCurrent(t)).leave.invoke(e,i)}),e||!i||i.isHistory()?this.behavior(t).endEnter.push(function(e,r,o){return n.behavior(o||i.isHistory()?r.getCurrent(t)||i:i).enter().invoke(e,r,o||i.kind===v.DeepHistory)}):this.behavior(t).endEnter.pushh(this.behavior(i).enter()),this.visitElement(t,e)},e.prototype.visitPseudoState=function(e,n){var i=this
t.prototype.visitPseudoState.call(this,e,n),e.isInitial()?this.behavior(e).endEnter.push(function(t,n,r){n.getCurrent(e.region)?(i.behavior(e).leave.invoke(t,n),i.behavior(n.getCurrent(e.region)).enter().invoke(t,n,r||e.kind===v.DeepHistory)):u(e.outgoing[0],n)}):e.kind===v.Terminate&&this.behavior(e).beginEnter.push(function(t,e){return e.isTerminated=!0})},e.prototype.visitState=function(t,e){for(var n=0,i=t.regions;n<i.length;n++){var r=i[n]
r.accept(this,e),this.behavior(t).leave.pushh(this.behavior(r).leave),this.behavior(t).endEnter.pushh(this.behavior(r).enter())}this.visitVertex(t,e),this.behavior(t).leave.pushh(t.exitBehavior),this.behavior(t).beginEnter.pushh(t.entryBehavior),this.behavior(t).beginEnter.push(function(e,n){t.region&&n.setCurrent(t.region,t)})},e.prototype.visitStateMachine=function(e,n){var i=this
t.prototype.visitStateMachine.call(this,e,n),e.accept(new I,function(t){return i.behavior(t)}),e.onInitialise=this.behavior(e).enter()},e}(x),N={log:function(){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e]},warn:function(){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e]},error:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n]
throw t}}
n.console=N,n.internalTransitionsTriggerCompletion=!1,n.validate=l
var B=function(t){function e(){t.apply(this,arguments)}return p(e,t),e.prototype.visitPseudoState=function(e){t.prototype.visitPseudoState.call(this,e),e.kind===v.Choice||e.kind===v.Junction?(0===e.outgoing.length&&n.console.error(e+": "+e.kind+" pseudo states must have at least one outgoing transition."),e.outgoing.filter(function(t){return t.guard===w.FalseGuard}).length>1&&n.console.error(e+": "+e.kind+" pseudo states cannot have more than one Else transitions.")):(0!==e.outgoing.filter(function(t){return t.guard===w.FalseGuard}).length&&n.console.error(e+": "+e.kind+" pseudo states cannot have Else transitions."),e.isInitial()&&(e.outgoing.length>1?n.console.error(e+": initial pseudo states must have no more than one outgoing transition."):1===e.outgoing.length&&e.outgoing[0].guard!==w.TrueGuard&&n.console.error(e+": initial pseudo states cannot have a guard condition.")))},e.prototype.visitRegion=function(e){t.prototype.visitRegion.call(this,e)
for(var i=0,r=0,o=0,s=0,a=e.vertices;s<a.length;s++){var u=a[s]
u instanceof b&&(u.kind===v.Initial?i++:u.kind===v.DeepHistory?r++:u.kind===v.ShallowHistory&&o++)}i>1&&n.console.error(e+": regions may have at most one initial pseudo state."),r>1&&n.console.error(e+": regions may have at most one deep history pseudo state."),o>1&&n.console.error(e+": regions may have at most one shallow history pseudo state.")},e.prototype.visitState=function(e){t.prototype.visitState.call(this,e),e.regions.filter(function(t){return t.name===y.defaultName}).length>1&&n.console.error(e+": a state cannot have more than one region named "+y.defaultName)},e.prototype.visitFinalState=function(e){t.prototype.visitFinalState.call(this,e),0!==e.outgoing.length&&n.console.error(e+": final states must not have outgoing transitions."),0!==e.regions.length&&n.console.error(e+": final states must not have child regions."),e.entryBehavior.length>0&&n.console.warn(e+": final states may not have entry behavior."),e.exitBehavior.length>0&&n.console.warn(e+": final states may not have exit behavior.")},e.prototype.visitTransition=function(e){t.prototype.visitTransition.call(this,e),e.kind===g.Local&&-1===e.target.ancestry().indexOf(e.source)&&n.console.error(e+": local transition target vertices must be a child of the source composite sate.")},e}(x)},{}],2:[function(t){window[((document.currentScript||document.getElementsByTagName("script")[scripts.length-1]).attributes.target||{textContent:"fsm"}).textContent]=t("../lib/state.com")},{"../lib/state.com":1}]},{},[2])
