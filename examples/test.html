<!DOCTYPE html>
<html lang="en">
    <head>
        <title>state.js v5.0.0 test</title>
		<script src="../src/state.js"></script>
        <script>
            var machine = new FSM.StateMachine("player");
            var initial = new FSM.PseudoState("initial", machine, FSM.PseudoStateKind.Initial);
            var operational = new FSM.State("operational", machine);
            var flipped = new FSM.State("flipped", machine);
            var final = new FSM.FinalState("final", machine);
            var dhistory = new FSM.PseudoState("history", operational, FSM.PseudoStateKind.DeepHistory);
            var stopped = new FSM.State("stopped", operational);
            var active = new FSM.State("active", operational).entry(engageHead).exit(disengageHead);
            var running = new FSM.State("running", active).entry(startMotor).exit(stopMotor);
            var paused = new FSM.State("paused", active);
            initial.to(operational).effect(disengageHead).effect(stopMotor);
            
            dhistory.to(stopped);
            stopped.to(running).when(function (command) { return command === "play"; });
            active.to(stopped).when(function (command) { return command === "stop"; });
            running.to(paused).when(function (command) { return command === "pause"; });
            paused.to(running).when(function (command) { return command === "play"; });
            operational.to(flipped).when(function (command) { return command === "flip"; });
            flipped.to(operational).when(function (command) { return command === "flip"; });
            operational.to(final).when(function (command) { return command === "off"; });            
            
			function init()
			{
				sms = new FSM.Context();
				machine.initialise( sms )
			}

			function engageHead(context, message)
			{
				document.getElementById("head").innerHTML = "Head: engaged";
			}
			
			function disengageHead(context, message)
			{
				document.getElementById("head").innerHTML = "Head: disengaged";
			}
			
			function startMotor(context, message)
			{
				document.getElementById("motor").innerHTML = "Motor: running";
			}
			
			function stopMotor(context, message)
			{
				document.getElementById("motor").innerHTML = "Motor: stopped";
			}
			
			// add a little more behavior to adjust the graphic
			stopped.entry(function() { updateGraphic( "controller_stopped.png" ); });
			running.entry(function() { updateGraphic( "controller_running.png" ); });
			paused.entry(function() { updateGraphic( "controller_paused.png" ); });
			operational.exit(function() { updateGraphic( "controller_final.png" ); });
			flipped.entry(function() { updateGraphic( "controller_flipped.png" ); });
			
			function updateGraphic( uri )
			{
				document.getElementById( "diagram" ).src = uri;
			}
        </script>
    </head>
	<body onload="init()">
        <h1>state.js v5.0.0 test</h1>
		<p>This example implements a simple controller for a cassette player according to the model below:</p>
		<p><img id="diagram" /></p>
		<p>Press the buttons below to send events to the controller (check brower console for trace output):</p>
		<button type="button" onclick="machine.evaluate('play', sms)">play</button>
		<button type="button" onclick="machine.evaluate('pause', sms)">pause</button>
		<button type="button" onclick="machine.evaluate('stop', sms)">stop</button>
		<button type="button" onclick="machine.evaluate('flip', sms)">flip</button>
		<button type="button" onclick="machine.evaluate('off', sms)">off</button>
		<button type="button" onclick="init()">reset</button>
		<button type="button" onclick="console.log( JSON.stringify( machine.getCurrent(sms) ) )">current</button>
		<p id="head">Head: </p>
		<p id="motor">Motor: </p>
	</body>
</html>