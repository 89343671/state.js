!function t(n,e,i){function r(a,s){if(!e[a]){if(!n[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(o)return o(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var p=e[a]={exports:{}};n[a][0].call(p.exports,function(t){var e=n[a][1][t];return r(e?e:t)},p,p.exports,t,n,e,i)}return e[a].exports}for(var o="function"==typeof require&&require,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(t,n,e){"use strict";function i(t){var n=v;return v=t,n}function r(t){var n=g;return g=t,n}function o(t){var n=y;return y=t,n}function a(t){var n=d;return d=t,n}function s(t,n,e){for(var i=[],r=3;r<arguments.length;r++)i[r-3]=arguments[r];for(var o=0,a=t;o<a.length;o++){var s=a[o];s.apply(void 0,[n,e].concat(i))}}function c(t){return t.outgoing.filter(function(t){return t.isElse()})[0]}function u(t,n){for(var e=[],i=2;i<arguments.length;i++)e[i-2]=arguments[i];var r=t.outgoing.filter(function(t){return t.evaluate.apply(t,[n].concat(e))});return t.kind===A.Choice?0!==r.length?r[g(r.length)]:c(t):(r.length>1&&v.error("Multiple outbound transition guards returned true at "+t+" for "+e),r[0]||c(t))}function p(t,n){for(var e=[],i=2;i<arguments.length;i++)e[i-2]=arguments[i];var r=!1;if(e[0]!==t&&t.children.every(function(i){var o=n.getLastKnownState(i);return!o||!p.apply(void 0,[o,n].concat(e))||(r=!0,t.isActive(n))}),t instanceof T)if(r)e[0]!==t&&t.isComplete(n)&&p(t,n,t);else{var o=t.outgoing.filter(function(t){return t.evaluate.apply(t,[n].concat(e))});1===o.length?(h.apply(void 0,[o[0],n].concat(e)),r=!0):o.length>1&&v.error(t+": multiple outbound transitions evaluated true for message "+e)}return r}function h(t,n){for(var e=[],i=2;i<arguments.length;i++)e[i-2]=arguments[i];for(var r=t.onTraverse.slice();t.target&&t.target instanceof C&&t.target.kind===A.Junction;)t=u.apply(void 0,[t.target,n].concat(e)),r.push.apply(r,t.onTraverse);s.apply(void 0,[r,n,!1].concat(e)),t.target&&(t.target instanceof C&&t.target.kind===A.Choice?h.apply(void 0,[u.apply(void 0,[t.target,n].concat(e)),n].concat(e)):t.target instanceof T&&t.target.isComplete(n)&&p(t.target,n,t.target))}var l=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e])};return function(n,e){function i(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();e.__esModule=!0;var f=t("./tree"),v={log:function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e]},error:function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];throw t}};e.setLogger=i;var g=function(t){return Math.floor(Math.random()*t)};e.setRandom=r;var y=!1;e.setInternalTransitionsTriggerCompletion=o;var d=".";e.setNamespaceSeparator=a;var A,m=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return!1};!function(t){t[t.Choice=0]="Choice",t[t.DeepHistory=1]="DeepHistory",t[t.Initial=2]="Initial",t[t.Junction=3]="Junction",t[t.ShallowHistory=4]="ShallowHistory"}(A=e.PseudoStateKind||(e.PseudoStateKind={}));var w;!function(t){t[t.External=0]="External",t[t.Internal=1]="Internal",t[t.Local=2]="Local"}(w=e.TransitionKind||(e.TransitionKind={}));var E=function(){function t(t,n){this.name=t,this.parent=n,this.qualifiedName=n?n.toString()+d+t:t}return t.prototype.toString=function(){return this.qualifiedName},t}();e.Element=E;var S=function(t){function n(n,e){var i=t.call(this,n,e)||this;return i.children=new Array,i.parent.children.push(i),i.invalidate(),i}return l(n,t),n.prototype.invalidate=function(){this.parent.invalidate()},n.prototype.isActive=function(t){return this.parent.isActive(t)},n.prototype.isComplete=function(t){var n=t.getLastKnownState(this);return void 0!==n&&n.isFinal()},n.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitRegion.apply(t,[this].concat(n))},n}(E);S.defaultName="default",e.Region=S;var x=function(t){function n(n,e){var i=t.call(this,n,e instanceof S?e:e.defaultRegion()||new S(S.defaultName,e))||this;return i.outgoing=new Array,i.incoming=new Array,i.parent.children.push(i),i.invalidate(),i}return l(n,t),n.prototype.invalidate=function(){this.parent.invalidate()},n.prototype.to=function(t,n){return void 0===n&&(n=w.External),new I(this,t,n)},n.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitVertex.apply(t,[this].concat(n))},n}(E);e.Vertex=x;var C=function(t){function n(n,e,i){void 0===i&&(i=A.Initial);var r=t.call(this,n,e)||this;return r.kind=i,r}return l(n,t),n.prototype.isHistory=function(){return this.kind===A.DeepHistory||this.kind===A.ShallowHistory},n.prototype.isInitial=function(){return this.kind===A.Initial||this.isHistory()},n.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitPseudoState.apply(t,[this].concat(n))},n}(x);e.PseudoState=C;var T=function(t){function n(n,e){var i=t.call(this,n,e)||this;return i.children=new Array,i.entryBehavior=new Array,i.exitBehavior=new Array,i}return l(n,t),n.prototype.defaultRegion=function(){return this.children.filter(function(t){return t.name===S.defaultName})[0]},n.prototype.isFinal=function(){return 0===this.outgoing.length},n.prototype.isSimple=function(){return 0===this.children.length},n.prototype.isComposite=function(){return this.children.length>0},n.prototype.isOrthogonal=function(){return this.children.length>1},n.prototype.isActive=function(t){return this.parent.isActive(t)&&t.getLastKnownState(this.parent)===this},n.prototype.isComplete=function(t){return this.children.every(function(n){return n.isComplete(t)})},n.prototype.exit=function(t){return this.exitBehavior.push(function(n,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];t.apply(void 0,[n].concat(i))}),this.invalidate(),this},n.prototype.entry=function(t){return this.entryBehavior.push(function(n,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];t.apply(void 0,[n].concat(i))}),this.invalidate(),this},n.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitState.apply(t,[this].concat(n))},n}(x);e.State=T;var b=function(){function t(t){this.name=t,this.parent=void 0,this.children=new Array,this.clean=!1,this.onInitialise=new Array}return t.prototype.invalidate=function(){this.clean=!1},t.prototype.defaultRegion=function(){return this.children.filter(function(t){return t.name===S.defaultName})[0]},t.prototype.isActive=function(t){return!0},t.prototype.isComplete=function(t){return this.children.every(function(n){return n.isComplete(t)})},t.prototype.initialise=function(t){t?(this.clean===!1&&this.initialise(),v.log("initialise "+t),s(this.onInitialise,t,!1,void 0)):(v.log("initialise "+this),this.accept(new L,!1,this.onInitialise),this.clean=!0)},t.prototype.evaluate=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return this.clean===!1&&this.initialise(),v.log(t+" evaluate message: "+n),p.apply(void 0,[this,t].concat(n))},t.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitStateMachine.apply(t,[this].concat(n))},t.prototype.toString=function(){return this.name},t}();e.StateMachine=b;var I=function(){function t(t,n,e){void 0===e&&(e=w.External);var i=this;this.source=t,this.target=n,this.kind=e,this.effectBehavior=new Array,this.onTraverse=new Array,this.guard=t instanceof C?function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return!0}:function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return n[0]===i.source},this.source.outgoing.push(this),this.target?(this.target.incoming.push(this),this.kind===w.Local&&(f.isChild(this.target,this.source)||(this.kind=w.External))):this.kind=w.Internal,this.source.invalidate()}return t.prototype.isElse=function(){return this.guard===m},t.prototype.else=function(){return this.guard=m,this},t.prototype.when=function(t){return this.guard=t,this},t.prototype.effect=function(t){return this.effectBehavior.push(function(n,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];t.apply(void 0,[n].concat(i))}),this.source.invalidate(),this},t.prototype.evaluate=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return this.guard.apply(this,[t].concat(n))},t.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitTransition.apply(t,[this].concat(n))},t}();e.Transition=I;var k=function(){function t(){}return t.prototype.visitElement=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e]},t.prototype.visitRegion=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=0,r=t.children;i<r.length;i++){var o=r[i];o.accept.apply(o,[this].concat(n))}this.visitElement.apply(this,[t].concat(n))},t.prototype.visitVertex=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=0,r=t.outgoing;i<r.length;i++){var o=r[i];o.accept.apply(o,[this].concat(n))}this.visitElement.apply(this,[t].concat(n))},t.prototype.visitPseudoState=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];this.visitVertex.apply(this,[t].concat(n))},t.prototype.visitState=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=0,r=t.children;i<r.length;i++){var o=r[i];o.accept.apply(o,[this].concat(n))}this.visitVertex.apply(this,[t].concat(n))},t.prototype.visitStateMachine=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=0,r=t.children;i<r.length;i++){var o=r[i];o.accept.apply(o,[this].concat(n))}this.visitElement.apply(this,[t].concat(n))},t.prototype.visitTransition=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e]},t}();e.Visitor=k;var _=function(){function t(t){this.name=t,this.asc={}}return t.prototype.find=function(t){var n=this.asc[t.qualifiedName];return n||(n={currentVertex:void 0,lastKnownState:void 0},this.asc[t.qualifiedName]=n),n},t.prototype.setCurrent=function(t,n){var e=this.find(t);e.currentVertex=n,n instanceof T&&(e.lastKnownState=n)},t.prototype.getCurrent=function(t){return this.find(t).currentVertex},t.prototype.getLastKnownState=function(t){return this.find(t).lastKnownState},t.prototype.toString=function(){return this.name},t}();e.DictionaryInstance=_;var H=function(){function t(){this.leave=new Array,this.beginEnter=new Array,this.endEnter=new Array}return t}(),L=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.elementActions={},n.transitions=new Array,n}return l(n,t),n.prototype.getActions=function(t){return this.elementActions[t.toString()]||(this.elementActions[t.toString()]=new H)},n.prototype.visitElement=function(t,n){this.getActions(t).leave.push(function(n,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];return v.log(n+" leave "+t)}),this.getActions(t).beginEnter.push(function(n,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];return v.log(n+" enter "+t)})},n.prototype.visitRegion=function(n,e){var i=this,r=n.children.reduce(function(t,n){return n instanceof C&&n.isInitial()&&(void 0===t||t.isHistory())?n:t},void 0);this.getActions(n).leave.push(function(t,e){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];var a=t.getCurrent(n);a&&s.apply(void 0,[i.getActions(a).leave,t,!1].concat(r))}),t.prototype.visitRegion.call(this,n,e||r&&r.kind===A.DeepHistory),e||!r||r.isHistory()?this.getActions(n).endEnter.push(function(t,e){for(var o=[],a=2;a<arguments.length;a++)o[a-2]=arguments[a];var c=i.getActions(e||r.isHistory()?t.getLastKnownState(n)||r:r),u=e||r.kind===A.DeepHistory;s.apply(void 0,[c.beginEnter,t,u].concat(o)),s.apply(void 0,[c.endEnter,t,u].concat(o))}):(o=this.getActions(n).endEnter).push.apply(o,this.getActions(r).beginEnter.concat(this.getActions(r).endEnter));var o},n.prototype.visitVertex=function(n,e){t.prototype.visitVertex.call(this,n,e),this.getActions(n).beginEnter.push(function(t,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];t.setCurrent(n.parent,n)})},n.prototype.visitPseudoState=function(n,e){var i=this;t.prototype.visitPseudoState.call(this,n,e),n.isInitial()&&this.getActions(n).endEnter.push(function(t,e){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];if(t.getLastKnownState(n.parent)){s.apply(void 0,[i.getActions(n).leave,t,!1].concat(r));var a=t.getLastKnownState(n.parent);a&&(s.apply(void 0,[i.getActions(a).beginEnter,t,e||n.kind===A.DeepHistory].concat(r)),s.apply(void 0,[i.getActions(a).endEnter,t,e||n.kind===A.DeepHistory].concat(r)))}else h(n.outgoing[0],t,!1)})},n.prototype.visitState=function(t,n){for(var e=0,i=t.children;e<i.length;e++){var r=i[e];r.accept(this,n),(o=this.getActions(t).leave).push.apply(o,this.getActions(r).leave),(a=this.getActions(t).endEnter).push.apply(a,this.getActions(r).beginEnter.concat(this.getActions(r).endEnter))}this.visitVertex(t,n),(s=this.getActions(t).leave).push.apply(s,t.exitBehavior),(c=this.getActions(t).beginEnter).push.apply(c,t.entryBehavior);var o,a,s,c},n.prototype.visitStateMachine=function(n,e,i){t.prototype.visitStateMachine.call(this,n,e);for(var r=0,o=this.transitions;r<o.length;r++){var a=o[r];switch(a.kind){case w.Internal:this.visitInternalTransition(a);break;case w.Local:this.visitLocalTransition(a);break;case w.External:this.visitExternalTransition(a)}}for(var s=0,c=n.children;s<c.length;s++){var u=c[s];i.push.apply(i,this.getActions(u).beginEnter.concat(this.getActions(u).endEnter))}},n.prototype.visitTransition=function(n,e){t.prototype.visitTransition.call(this,n,e),this.transitions.push(n)},n.prototype.visitInternalTransition=function(t){(n=t.onTraverse).push.apply(n,t.effectBehavior),y&&t.onTraverse.push(function(n,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];t.source instanceof T&&t.source.isComplete(n)&&p(t.source,n,t.source)});var n},n.prototype.visitLocalTransition=function(t){var n=this;t.onTraverse.push(function(e,i){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];for(var a=t.target,c=n.getActions(t.target).endEnter.slice();a!==t.source;)c.unshift.apply(c,n.getActions(a).beginEnter),a.parent.parent===t.source?c.unshift.apply(c,t.effectBehavior.concat(n.getActions(e.getCurrent(a.parent)).leave)):c.unshift.apply(c,n.getActions(a.parent).beginEnter),a=a.parent.parent;s.apply(void 0,[c,e,i].concat(r))})},n.prototype.visitExternalTransition=function(t){var n=f.ancestors(t.source),e=f.ancestors(t.target),i=f.lowestCommonAncestorIndex(n,e);for(n[i]instanceof S&&(i+=1),(r=t.onTraverse).push.apply(r,this.getActions(n[i]).leave.concat(t.effectBehavior));i<e.length;)(o=t.onTraverse).push.apply(o,this.getActions(e[i++]).beginEnter);(a=t.onTraverse).push.apply(a,this.getActions(t.target).endEnter);var r,o,a},n}(k)},{"./tree":2}],2:[function(t,n,e){"use strict";function i(t){var n=t&&t.parent?i(t.parent):[];return t&&n.push(t),n}function r(t,n){var e=0;if(t&&n)for(;e<t.length&&e<n.length&&t[e]===n[e];)e++;return e-1}function o(t,n){var e=i(t),o=i(n),a=r(e,o);return a===-1?void 0:e[a]}function a(t,n){for(;t;){if(t.parent===n)return!0;t=t.parent}return!1}function s(t){for(var n=-1;t;)n++,t=t.parent;return n}e.__esModule=!0,e.ancestors=i,e.lowestCommonAncestorIndex=r,e.lowestCommonAncestor=o,e.isChild=a,e.depth=s},{}],3:[function(t,n,e){window[((document.currentScript||document.getElementsByTagName("script")[scripts.length-1]).attributes.target||{textContent:"fsm"}).textContent]=t("../lib/node/state.js")},{"../lib/node/state.js":1}]},{},[3]);
