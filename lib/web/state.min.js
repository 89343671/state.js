!function t(n,e,i){function r(a,s){if(!e[a]){if(!n[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(o)return o(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var l=e[a]={exports:{}};n[a][0].call(l.exports,function(t){var e=n[a][1][t];return r(e?e:t)},l,l.exports,t,n,e,i)}return e[a].exports}for(var o="function"==typeof require&&require,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(t,n,e){"use strict";function i(t){var n=e.logger;return e.logger=t,n}function r(t){var n=e.random;return e.random=t,n}function o(t){var n=e.internalTransitionsTriggerCompletion;return e.internalTransitionsTriggerCompletion=t,n}function a(t,n,e){for(var i=[],r=3;r<arguments.length;r++)i[r-3]=arguments[r];for(var o=0,a=t;o<a.length;o++){var s=a[o];s.apply(void 0,[n,e].concat(i))}}function s(t){return t.outgoing.filter(function(t){return t.guard===S.Else})[0]}function c(t,n){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];var o=t.outgoing.filter(function(t){return t.guard.apply(t,[n].concat(i))});return t.kind===f.Choice?0!==o.length?o[e.random(o.length)]:s(t):(o.length>1&&e.logger.error("Multiple outbound transition guards returned true at "+t+" for "+i),o[0]||s(t))}function u(t,n){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];var o=!1;if(i[0]!==t&&t.children.every(function(e){var r=n.getLastKnownState(e);return!r||!u.apply(void 0,[r,n].concat(i))||(o=!0,t.isActive(n))}),t instanceof A)if(o)i[0]!==t&&t.isComplete(n)&&u(t,n,t);else{var a=t.outgoing.filter(function(t){return t.guard.apply(t,[n].concat(i))});1===a.length?(l.apply(void 0,[a[0],n].concat(i)),o=!0):a.length>1&&e.logger.error(t+": multiple outbound transitions evaluated true for message "+i)}return o}function l(t,n){for(var e=[],i=2;i<arguments.length;i++)e[i-2]=arguments[i];for(var r=t.onTraverse.slice(),o=t;o.target&&o.target instanceof m&&o.target.kind===f.Junction;)o=c.apply(void 0,[o.target,n].concat(e)),r=r.concat(o.onTraverse);a.apply(void 0,[r,n,!1].concat(e)),o.target&&(o.target instanceof m&&o.target.kind===f.Choice?l.apply(void 0,[c.apply(void 0,[o.target,n].concat(e)),n].concat(e)):o.target instanceof A&&o.target.isComplete(n)&&u(o.target,n,o.target))}var p=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e])};return function(n,e){function i(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();e.__esModule=!0;var h=t("./tree");e.logger={log:function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e]},error:function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];throw t}},e.setLogger=i,e.random=function(t){return Math.floor(Math.random()*t)},e.setRandom=r,e.internalTransitionsTriggerCompletion=!1,e.setInternalTransitionsTriggerCompletion=o;var f;!function(t){t[t.Choice=0]="Choice",t[t.DeepHistory=1]="DeepHistory",t[t.Initial=2]="Initial",t[t.Junction=3]="Junction",t[t.ShallowHistory=4]="ShallowHistory"}(f=e.PseudoStateKind||(e.PseudoStateKind={}));var v;!function(t){t[t.External=0]="External",t[t.Internal=1]="Internal",t[t.Local=2]="Local"}(v=e.TransitionKind||(e.TransitionKind={}));var g=function(){function t(n,e){this.name=n,this.parent=e,this.children=new Array,this.qualifiedName=e?e.toString()+t.namespaceSeparator+n:n}return t.prototype.invalidate=function(){return this.parent.invalidate()},t.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitElement.apply(t,[this].concat(n))},t.prototype.toString=function(){return this.qualifiedName},t}();g.namespaceSeparator=".",e.Element=g;var d=function(t){function n(n,e){var i=t.call(this,n,e)||this;return i.parent.children.push(i),i.invalidate(),i}return p(n,t),n.prototype.isActive=function(t){return this.parent.isActive(t)},n.prototype.isComplete=function(t){var n=t.getLastKnownState(this);return void 0!==n&&n.isFinal()},n.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitRegion.apply(t,[this].concat(n))},n}(g);d.defaultName="default",e.Region=d;var y=function(t){function n(n,e){var i=t.call(this,n,e instanceof d?e:A.defaultRegion(e))||this;return i.outgoing=new Array,i.incoming=new Array,i.parent.children.push(i),i.invalidate(),i}return p(n,t),n.prototype.to=function(t,n){return void 0===n&&(n=v.External),new S(this,t,n)},n.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitVertex.apply(t,[this].concat(n))},n}(g);e.Vertex=y;var m=function(t){function n(n,e,i){void 0===i&&(i=f.Initial);var r=t.call(this,n,e)||this;return r.kind=i,r}return p(n,t),n.prototype.isHistory=function(){return this.kind===f.DeepHistory||this.kind===f.ShallowHistory},n.prototype.isInitial=function(){return this.kind===f.Initial||this.isHistory()},n.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitPseudoState.apply(t,[this].concat(n))},n}(y);e.PseudoState=m;var A=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.entryBehavior=[],n.exitBehavior=[],n}return p(n,t),n.defaultRegion=function(t){for(var n=0,e=t.children;n<e.length;n++){var i=e[n];if(i.name===d.defaultName)return i}return new d(d.defaultName,t)},n.prototype.isFinal=function(){return 0===this.outgoing.length},n.prototype.isSimple=function(){return 0===this.children.length},n.prototype.isComposite=function(){return this.children.length>0},n.prototype.isOrthogonal=function(){return this.children.length>1},n.prototype.isActive=function(t){return this.parent.isActive(t)&&t.getLastKnownState(this.parent)===this},n.prototype.isComplete=function(t){return this.children.every(function(n){return n.isComplete(t)})},n.prototype.exit=function(t){return this.exitBehavior.push(function(n,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];t.apply(void 0,[n].concat(i))}),this.invalidate(),this},n.prototype.entry=function(t){return this.entryBehavior.push(function(n,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];t.apply(void 0,[n].concat(i))}),this.invalidate(),this},n.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitState.apply(t,[this].concat(n))},n}(y);e.State=A;var E=function(){function t(t){this.name=t,this.parent=void 0,this.children=new Array,this.clean=!1,this.onInitialise=[]}return t.prototype.invalidate=function(){this.clean=!1},t.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitStateMachine.apply(t,[this].concat(n))},t.prototype.isActive=function(t){return!0},t.prototype.isComplete=function(t){return this.children.every(function(n){return n.isComplete(t)})},t.prototype.initialise=function(t){t?(this.clean===!1&&this.initialise(),e.logger.log("initialise "+t),a(this.onInitialise,t,!1,void 0)):(e.logger.log("initialise "+this),this.accept(new x,!1),this.clean=!0)},t.prototype.evaluate=function(t){for(var n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];return this.clean===!1&&this.initialise(),e.logger.log(t+" evaluate message: "+n),u.apply(void 0,[this,t].concat(n))},t.prototype.toString=function(){return this.name},t}();e.StateMachine=E;var S=function(){function t(t,n,e){void 0===e&&(e=v.External);var i=this;this.source=t,this.target=n,this.kind=e,this.effectBehavior=[],this.onTraverse=[],this.guard=t instanceof m?function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return!0}:function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return n[0]===i.source},this.source.outgoing.push(this),this.source.invalidate(),this.target?this.target.incoming.push(this):this.kind=v.Internal}return t.prototype.else=function(){return this.guard=t.Else,this},t.prototype.when=function(t){return this.guard=t,this},t.prototype.effect=function(t){return this.effectBehavior.push(function(n,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];t.apply(void 0,[n].concat(i))}),this.source.invalidate(),this},t.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitTransition.apply(t,[this].concat(n))},t.prototype.toString=function(){return v[this.kind]+"("+(this.kind===v.Internal?this.source:this.source+" -> "+this.target)+")"},t}();S.Else=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];return!1},e.Transition=S;var T=function(){function t(){}return t.prototype.visitElement=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e]},t.prototype.visitRegion=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=0,r=t.children;i<r.length;i++){var o=r[i];o.accept.apply(o,[this].concat(n))}this.visitElement.apply(this,[t].concat(n))},t.prototype.visitVertex=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=0,r=t.outgoing;i<r.length;i++){var o=r[i];o.accept.apply(o,[this].concat(n))}this.visitElement.apply(this,[t].concat(n))},t.prototype.visitPseudoState=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];this.visitVertex.apply(this,[t].concat(n))},t.prototype.visitState=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=0,r=t.children;i<r.length;i++){var o=r[i];o.accept.apply(o,[this].concat(n))}this.visitVertex.apply(this,[t].concat(n))},t.prototype.visitStateMachine=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=0,r=t.children;i<r.length;i++){var o=r[i];o.accept.apply(o,[this].concat(n))}this.visitElement.apply(this,[t].concat(n))},t.prototype.visitTransition=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e]},t}();e.Visitor=T;var w=function(){function t(t){this.name=t,this.current={},this.activeStateConfiguration={}}return t.prototype.setCurrent=function(t,n){this.current[t.qualifiedName]=n,n instanceof A&&(this.activeStateConfiguration[t.qualifiedName]=n)},t.prototype.getCurrent=function(t){return this.current[t.qualifiedName]},t.prototype.getLastKnownState=function(t){return this.activeStateConfiguration[t.qualifiedName]},t.prototype.toString=function(){return this.name},t}();e.DictionaryInstance=w;var C=function(){function t(){this.leave=[],this.beginEnter=[],this.endEnter=[]}return t}(),x=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.elementActions={},n.transitions=new Array,n}return p(n,t),n.prototype.getActions=function(t){return this.elementActions[t.toString()]||(this.elementActions[t.toString()]=new C)},n.prototype.visitElement=function(t,n){this.getActions(t).leave.push(function(n,i){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];return e.logger.log(n+" leave "+t)}),this.getActions(t).beginEnter.push(function(n,i){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];return e.logger.log(n+" enter "+t)})},n.prototype.visitRegion=function(n,e){var i=this,r=n.children.reduce(function(t,n){return n instanceof m&&n.isInitial()&&(void 0===t||t.isHistory())?n:t},void 0);this.getActions(n).leave.push(function(t,e){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];var s=t.getCurrent(n);s&&a.apply(void 0,[i.getActions(s).leave,t,!1].concat(r))}),t.prototype.visitRegion.call(this,n,e||r&&r.kind===f.DeepHistory),e||!r||r.isHistory()?this.getActions(n).endEnter.push(function(t,e){for(var o=[],s=2;s<arguments.length;s++)o[s-2]=arguments[s];var c=i.getActions(e||r.isHistory()?t.getLastKnownState(n)||r:r),u=e||r.kind===f.DeepHistory;a.apply(void 0,[c.beginEnter,t,u].concat(o)),a.apply(void 0,[c.endEnter,t,u].concat(o))}):this.getActions(n).endEnter=this.getActions(n).endEnter.concat(this.getActions(r).beginEnter,this.getActions(r).endEnter)},n.prototype.visitVertex=function(n,e){t.prototype.visitVertex.call(this,n,e),this.getActions(n).beginEnter.push(function(t,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];t.setCurrent(n.parent,n)})},n.prototype.visitPseudoState=function(n,e){var i=this;t.prototype.visitPseudoState.call(this,n,e),n.isInitial()&&this.getActions(n).endEnter.push(function(t,e){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];if(t.getLastKnownState(n.parent)){a.apply(void 0,[i.getActions(n).leave,t,!1].concat(r));var s=t.getLastKnownState(n.parent);s&&(a.apply(void 0,[i.getActions(s).beginEnter,t,e||n.kind===f.DeepHistory].concat(r)),a.apply(void 0,[i.getActions(s).endEnter,t,e||n.kind===f.DeepHistory].concat(r)))}else l(n.outgoing[0],t,!1)})},n.prototype.visitState=function(t,n){for(var e=0,i=t.children;e<i.length;e++){var r=i[e];r.accept(this,n),this.getActions(t).leave=this.getActions(t).leave.concat(this.getActions(r).leave),this.getActions(t).endEnter=this.getActions(t).endEnter.concat(this.getActions(r).beginEnter,this.getActions(r).endEnter)}this.visitVertex(t,n),this.getActions(t).leave=this.getActions(t).leave.concat(t.exitBehavior),this.getActions(t).beginEnter=this.getActions(t).beginEnter.concat(t.entryBehavior)},n.prototype.visitStateMachine=function(n,e){t.prototype.visitStateMachine.call(this,n,e);for(var i=0,r=this.transitions;i<r.length;i++){var o=r[i];switch(o.kind){case v.Internal:this.visitInternalTransition(o);break;case v.Local:this.visitLocalTransition(o);break;case v.External:this.visitExternalTransition(o)}}for(var a=0,s=n.children;a<s.length;a++){var c=s[a];n.onInitialise=n.onInitialise.concat(this.getActions(c).beginEnter,this.getActions(c).endEnter)}},n.prototype.visitTransition=function(n,e){t.prototype.visitTransition.call(this,n,e),this.transitions.push(n)},n.prototype.visitInternalTransition=function(t){t.onTraverse=t.onTraverse.concat(t.effectBehavior),e.internalTransitionsTriggerCompletion&&t.onTraverse.push(function(n,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];t.source instanceof A&&t.source.isComplete(n)&&u(t.source,n,t.source)})},n.prototype.visitLocalTransition=function(t){var n=this;t.onTraverse.push(function(e,i){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];var s=h.Ancestors(t.source),c=h.Ancestors(t.target),u=h.LowestCommonAncestorIndex(s,c)+2,l=c[u],p=e.getCurrent(l.parent);for(a.apply(void 0,[n.getActions(p).leave,e,!1].concat(r)),a.apply(void 0,[t.effectBehavior,e,!1].concat(r));u<c.length;)a.apply(void 0,[n.getActions(c[u++]).beginEnter,e,!1].concat(r));a.apply(void 0,[n.getActions(t.target).endEnter,e,!1].concat(r))})},n.prototype.visitExternalTransition=function(t){var n=h.Ancestors(t.source),e=h.Ancestors(t.target),i=h.LowestCommonAncestorIndex(n,e);for(n[i]instanceof d&&(i+=1),t.onTraverse=t.onTraverse.concat(this.getActions(n[i]).leave,t.effectBehavior);i<e.length;)t.onTraverse=t.onTraverse.concat(this.getActions(e[i++]).beginEnter);t.onTraverse=t.onTraverse.concat(this.getActions(t.target).endEnter)},n}(T)},{"./tree":2}],2:[function(t,n,e){"use strict";function i(t){var n=t.parent?i(t.parent):new Array;return n.push(t),n}function r(t,n){for(var e=0;e<t.length&&e<n.length&&t[e]===n[e];)e++;return e-1}e.__esModule=!0,e.Ancestors=i,e.LowestCommonAncestorIndex=r},{}],3:[function(t,n,e){window[((document.currentScript||document.getElementsByTagName("script")[scripts.length-1]).attributes.target||{textContent:"fsm"}).textContent]=t("../lib/node/state.js")},{"../lib/node/state.js":1}]},{},[3]);
