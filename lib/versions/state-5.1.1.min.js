var __extends=this.__extends||function(t,i){function e(){this.constructor=t}for(var n in i)i.hasOwnProperty(n)&&(t[n]=i[n])
e.prototype=i.prototype,t.prototype=new e},fsm
!function(t){function i(t,i,e,n){for(var r=0,o=t.length;o>r;r++)t[r](i,e,n)}var e=function(){function t(t){this.name=t}return t.prototype.getParent=function(){},t.prototype.root=function(){return this.getParent().root()},t.prototype.ancestors=function(){return(this.getParent()?this.getParent().ancestors():[]).concat(this)},t.prototype.isActive=function(t){return this.getParent().isActive(t)},t.prototype.toString=function(){return this.qualifiedName},t.namespaceSeparator=".",t}()
t.Element=e
var n=function(t){function i(i,e){t.call(this,i),this.parent=e,this.vertices=[],e.regions.push(this),e.root().clean=!1}return __extends(i,t),i.prototype.getParent=function(){return this.parent},i.prototype.isComplete=function(t){return t.getCurrent(this).isFinal()},i.prototype.evaluate=function(t,i){return i.getCurrent(this).evaluate(t,i)},i.prototype.accept=function(t,i){return t.visitRegion(this,i)},i.defaultName="default",i}(e)
t.Region=n
var r=function(t){function e(i,e){t.call(this,i),this.transitions=[],e instanceof n?this.region=e:e instanceof a&&(this.region=e.defaultRegion()),this.region&&(this.region.vertices.push(this),this.region.root().clean=!1)}return __extends(e,t),e.prototype.getParent=function(){return this.region},e.prototype.isComplete=function(){},e.prototype.to=function(t){var i=new c(this,t)
return this.transitions.push(i),this.root().clean=!1,i},e.prototype.select=function(){},e.prototype.evaluate=function(t,e){var n=this.select(t,e)
return n?(i(n.traverse,t,e,!1),!0):!1},e.prototype.accept=function(){},e}(e)
t.Vertex=r,function(t){t[t.Initial=0]="Initial",t[t.ShallowHistory=1]="ShallowHistory",t[t.DeepHistory=2]="DeepHistory",t[t.Choice=3]="Choice",t[t.Junction=4]="Junction",t[t.Terminate=5]="Terminate"}(t.PseudoStateKind||(t.PseudoStateKind={}))
var o=t.PseudoStateKind,s=function(t){function i(i,e,n){t.call(this,i,e),this.kind=n,this.isInitial()&&(this.region.initial=this)}return __extends(i,t),i.prototype.isComplete=function(){return!0},i.prototype.isHistory=function(){return this.kind===o.DeepHistory||this.kind===o.ShallowHistory},i.prototype.isInitial=function(){return this.kind===o.Initial||this.isHistory()},i.prototype.select=function(t,i){switch(this.kind){case o.Initial:case o.DeepHistory:case o.ShallowHistory:if(1===this.transitions.length)return this.transitions[0]
throw"Initial transition must have a single outbound transition from "+this.qualifiedName
case o.Junction:for(var e,n,r=0,s=this.transitions.length;s>r;r++)if(this.transitions[r].guard===c.isElse){if(n)throw"Multiple outbound transitions evaluated true"
n=this.transitions[r]}else if(this.transitions[r].guard(t,i)){if(e)throw"Multiple outbound transitions evaluated true"
e=this.transitions[r]}return e||n
case o.Choice:for(var a=[],r=0,s=this.transitions.length;s>r;r++)if(this.transitions[r].guard===c.isElse){if(n)throw"Multiple outbound else transitions found at "+this+" for "+t
n=this.transitions[r]}else this.transitions[r].guard(t,i)&&a.push(this.transitions[r])
return 0!==a.length?a[Math.round((a.length-1)*Math.random())]:n
default:return null}},i.prototype.accept=function(t,i){return t.visitPseudoState(this,i)},i}(r)
t.PseudoState=s
var a=function(t){function i(i,e){t.call(this,i,e),this.exitBehavior=[],this.entryBehavior=[],this.regions=[]}return __extends(i,t),i.prototype.defaultRegion=function(){for(var t,i=0,e=this.regions.length;e>i;i++)this.regions[i].name===n.defaultName&&(t=this.regions[i])
return t||(t=new n(n.defaultName,this)),t},i.prototype.isActive=function(i){return t.prototype.isActive.call(this,i)&&i.getCurrent(this.region)===this},i.prototype.isFinal=function(){return 0===this.transitions.length},i.prototype.isSimple=function(){return 0===this.regions.length},i.prototype.isComposite=function(){return this.regions.length>0},i.prototype.isOrthogonal=function(){return this.regions.length>1},i.prototype.isComplete=function(t){for(var i=0,e=this.regions.length;e>i;i++)if(this.regions[i].isComplete(t)===!1)return!1
return!0},i.prototype.exit=function(t){return this.exitBehavior.push(t),this.root().clean=!1,this},i.prototype.entry=function(t){return this.entryBehavior.push(t),this.root().clean=!1,this},i.prototype.select=function(t,i){for(var e,n=0,r=this.transitions.length;r>n;n++)if(this.transitions[n].guard(t,i)){if(e)throw"Multiple outbound transitions evaluated true"
e=this.transitions[n]}return e},i.prototype.evaluate=function(i,e){for(var n=!1,r=0,o=this.regions.length;o>r;r++)this.isActive(e)===!0&&this.regions[r].evaluate(i,e)&&(n=!0)
return n===!1&&(n=t.prototype.evaluate.call(this,i,e)),n===!0&&i!==this&&this.isComplete(e)&&this.evaluate(this,e),n},i.prototype.accept=function(t,i){return t.visitState(this,i)},i}(r)
t.State=a
var u=function(t){function i(i,e){t.call(this,i,e)}return __extends(i,t),i.prototype.to=function(){throw"A FinalState cannot be the source of a transition."},i.prototype.accept=function(t,i){return t.visitFinalState(this,i)},i}(a)
t.FinalState=u
var h=function(t){function e(i){t.call(this,i,void 0),this.clean=!1}return __extends(e,t),e.prototype.root=function(){return this.region?this.region.root():this},e.prototype.isActive=function(t){return this.region?this.region.isActive(t):!0},e.prototype.initialiseModel=function(){this.clean=!0,this.accept(v.instance,!1)},e.prototype.initialise=function(t,e){void 0===e&&(e=!0),e&&this.clean===!1&&this.initialiseModel(),i(this.init,void 0,t,!1)},e.prototype.evaluate=function(i,e,n){return void 0===n&&(n=!0),n&&this.clean===!1&&this.initialiseModel(),e.isTerminated?!1:t.prototype.evaluate.call(this,i,e)},e.prototype.accept=function(t,i){return t.visitStateMachine(this,i)},e}(a)
t.StateMachine=h
var c=function(){function t(t,i){var e=this
this.source=t,this.target=i,this.transitionBehavior=[],this.traverse=[],this.guard=function(t){return t===e.source}}return t.prototype["else"]=function(){return this.guard=t.isElse,this},t.prototype.when=function(t){return this.guard=t,this},t.prototype.effect=function(t){return this.transitionBehavior.push(t),this.source.root().clean=!1,this},t.prototype.accept=function(t,i){return t.visitTransition(this,i)},t.isElse=function(){return!1},t}()
t.Transition=c
var p=function(){function t(){}return t.prototype.visitElement=function(){},t.prototype.visitRegion=function(t,i){for(var e=this.visitElement(t,i),n=0,r=t.vertices.length;r>n;n++)t.vertices[n].accept(this,i)
return e},t.prototype.visitVertex=function(t,i){for(var e=this.visitElement(t,i),n=0,r=t.transitions.length;r>n;n++)t.transitions[n].accept(this,i)
return e},t.prototype.visitPseudoState=function(t,i){return this.visitVertex(t,i)},t.prototype.visitState=function(t,i){for(var e=this.visitVertex(t,i),n=0,r=t.regions.length;r>n;n++)t.regions[n].accept(this,i)
return e},t.prototype.visitFinalState=function(t,i){return this.visitState(t,i)},t.prototype.visitStateMachine=function(t,i){return this.visitState(t,i)},t.prototype.visitTransition=function(){},t}()
t.Visitor=p
var l=function(){function t(){this.leave=[],this.beginEnter=[],this.endEnter=[],this.enter=[]}return t}(),f=function(t){function i(){t.apply(this,arguments)}return __extends(i,t),i.prototype.visitTransition=function(t,i){if(t.target)if(t.target.getParent()===t.source.getParent())t.traverse=i(t.source).leave.concat(t.transitionBehavior).concat(i(t.target).enter)
else{for(var e=t.source.ancestors(),r=t.target.ancestors(),o=e.length,s=r.length,u=0,h=Math.min(o,s);h>u&&e[u]===r[u];)u++
if(e[u]instanceof n)throw"Transitions may not cross sibling orthogonal region boundaries"
for(t.traverse=i(o>u?e[u]:t.source).leave.slice(0),t.traverse=t.traverse.concat(t.transitionBehavior),u>=s&&(t.traverse=t.traverse.concat(i(t.target).beginEnter));s>u;){var c=r[u++],p=s>u?r[u]:void 0
if(t.traverse=t.traverse.concat(i(c).beginEnter),c instanceof a){var l=c
if(l.isOrthogonal())for(var f=0,v=l.regions.length;v>f;f++){var g=l.regions[f]
g!==p&&(t.traverse=t.traverse.concat(i(g).enter))}}}t.traverse=t.traverse.concat(i(t.target).endEnter)}else t.traverse=t.transitionBehavior},i.instance=new i,i}(p),v=function(t){function n(){t.apply(this,arguments)}return __extends(n,t),n.prototype.behaviour=function(t){return t.qualifiedName||(t.qualifiedName=t.ancestors().map(function(t){return t.name}).join(e.namespaceSeparator)),this.behaviours[t.qualifiedName]||(this.behaviours[t.qualifiedName]=new l)},n.prototype.visitElement=function(t){var i=this.behaviour(t)
i.enter=i.beginEnter.concat(i.endEnter)},n.prototype.visitRegion=function(t,e){for(var n=this,r=this.behaviour(t),s=0,a=t.vertices.length;a>s;s++)t.vertices[s].accept(this,e||t.initial&&t.initial.kind===o.DeepHistory)
r.leave.push(function(e,r,o){i(n.behaviour(r.getCurrent(t)).leave,e,r,o)}),e||!t.initial||t.initial.isHistory()?r.endEnter.push(function(e,r,s){var a=t.initial;(s||t.initial.isHistory())&&(a=r.getCurrent(t)||t.initial),i(n.behaviour(a).enter,e,r,s||t.initial.kind===o.DeepHistory)}):r.endEnter=r.endEnter.concat(this.behaviour(t.initial).enter),this.visitElement(t,e)},n.prototype.visitVertex=function(t,i){this.visitElement(t,i)
var e=this.behaviour(t)
e.endEnter.push(function(i,e){t.isComplete(e)&&t.evaluate(t,e)}),e.enter=e.beginEnter.concat(e.endEnter)},n.prototype.visitPseudoState=function(t,i){this.visitVertex(t,i),t.kind===o.Terminate&&this.behaviour(t).enter.push(function(t,i){i.isTerminated=!0})},n.prototype.visitState=function(t,e){for(var n=this.behaviour(t),r=0,o=t.regions.length;o>r;r++){var s=t.regions[r],a=this.behaviour(s)
s.accept(this,e),n.leave.push(function(t,e,n){i(a.leave,t,e,n)}),n.endEnter=n.endEnter.concat(a.enter)}this.visitVertex(t,e),n.leave=n.leave.concat(t.exitBehavior),n.beginEnter=n.beginEnter.concat(t.entryBehavior),n.beginEnter.push(function(i,e){t.region&&e.setCurrent(t.region,t)}),n.enter=n.beginEnter.concat(n.endEnter)},n.prototype.visitStateMachine=function(t,i){var e=this
this.behaviours={},this.visitState(t,i),t.accept(f.instance,function(t){return e.behaviour(t)}),t.init=this.behaviour(t).enter},n.instance=new n,n}(p),g=function(){function t(t){void 0===t&&(t="unnamed"),this.name=t,this.isTerminated=!1,this.last={}}return t.prototype.setCurrent=function(t,i){this.last[t.qualifiedName]=i},t.prototype.getCurrent=function(t){return this.last[t.qualifiedName]},t.prototype.toString=function(){return this.name},t}()
t.StateMachineInstance=g}(fsm||(fsm={}))
