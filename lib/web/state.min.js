!function t(e,n,r){function i(a,s){if(!n[a]){if(!e[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(o)return o(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var h=n[a]={exports:{}};e[a][0].call(h.exports,function(t){var n=e[a][1][t];return i(n?n:t)},h,h.exports,t,e,n,r)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)i(r[a]);return i}({1:[function(t,e,n){"use strict";function r(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=t.filter(function(t){return t!==n.noop&&void 0!==t&&null!==t});return 0!==r.length?function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return r.map(function(e){return e.apply(void 0,t)})}:n.noop}n.__esModule=!0,n.noop=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]},n.create=r},{}],2:[function(t,e,n){"use strict";function r(t){var e=l;return l=t,e}function i(t){var e=p;return p=t,e}function o(t){var e=f;return f=t,e}function a(t){var e=v;return v=t,e}function s(t){var e=g;return g=t,e}var c=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();n.__esModule=!0;var u=t("./tree"),h=t("./delegate"),l={log:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n]},error:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];throw t}};n.setLogger=r;var p=function(t){return Math.floor(Math.random()*t)};n.setRandom=i;var f=!1;n.setInternalTransitionsTriggerCompletion=o;var v=".";n.setNamespaceSeparator=a;var g="default";n.setDefaultRegionName=s;var y;!function(t){t[t.Choice=0]="Choice",t[t.DeepHistory=1]="DeepHistory",t[t.Initial=2]="Initial",t[t.Junction=3]="Junction",t[t.ShallowHistory=4]="ShallowHistory"}(y=n.PseudoStateKind||(n.PseudoStateKind={})),function(t){function e(e){return e===t.DeepHistory||e===t.ShallowHistory}function n(e){return e===t.DeepHistory||e===t.Initial||e===t.ShallowHistory}t.isHistory=e,t.isInitial=n}(y=n.PseudoStateKind||(n.PseudoStateKind={}));var d;!function(t){t[t.External=0]="External",t[t.Internal=1]="Internal",t[t.Local=2]="Local"}(d=n.TransitionKind||(n.TransitionKind={}));var m=function(){function t(t,e){this.name=t,this.parent=e,this.invalidate()}return t.prototype.invalidate=function(){this.parent.invalidate()},t.prototype.toString=function(){return this.parent.toString()+v+this.name},t}();n.NamedElement=m;var A=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.children=new Array,r.parent.children.push(r),r}return c(e,t),e.prototype.isActive=function(t){return this.parent.isActive(t)},e.prototype.isComplete=function(t){var e=t.getLastKnownState(this);return void 0!==e&&e.isFinal()},e.prototype.accept=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return t.visitRegion.apply(t,[this].concat(e))},e}(m);n.Region=A;var E=function(t){function e(e,n){var r=t.call(this,e,n instanceof A?n:n.defaultRegion()||new A(g,n))||this;return r.outgoing=new Array,r.incoming=new Array,r.parent.children.push(r),r}return c(e,t),e.prototype.to=function(t,e){return void 0===e&&(e=d.External),new x(this,t,e)},e}(m);n.Vertex=E;var S=function(t){function e(e,n,r){void 0===r&&(r=y.Initial);var i=t.call(this,e,n)||this;return i.kind=r,i}return c(e,t),e.prototype.accept=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return t.visitPseudoState.apply(t,[this].concat(e))},e}(E);n.PseudoState=S;var w=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.children=new Array,r.entryBehavior=h.create(),r.exitBehavior=h.create(),r}return c(e,t),e.prototype.defaultRegion=function(){return this.children.filter(function(t){return t.name===g})[0]},e.prototype.isFinal=function(){return 0===this.outgoing.length},e.prototype.isSimple=function(){return 0===this.children.length},e.prototype.isComposite=function(){return this.children.length>0},e.prototype.isOrthogonal=function(){return this.children.length>1},e.prototype.isActive=function(t){return this.parent.isActive(t)&&t.getLastKnownState(this.parent)===this},e.prototype.isComplete=function(t){return this.children.every(function(e){return e.isComplete(t)})},e.prototype.exit=function(t){return this.exitBehavior=h.create(this.exitBehavior,function(e,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return t.apply(void 0,[e].concat(r))}),this.invalidate(),this},e.prototype.entry=function(t){return this.entryBehavior=h.create(this.entryBehavior,function(e,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return t.apply(void 0,[e].concat(r))}),this.invalidate(),this},e.prototype.accept=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return t.visitState.apply(t,[this].concat(e))},e}(E);n.State=w;var C=function(){function t(t){this.name=t,this.parent=void 0,this.children=new Array,this.onInitialise=h.create()}return t.prototype.invalidate=function(){this.onInitialise=h.create()},t.prototype.defaultRegion=function(){return this.children.filter(function(t){return t.name===g})[0]},t.prototype.isActive=function(t){return!0},t.prototype.isComplete=function(t){return this.children.every(function(e){return e.isComplete(t)})},t.prototype.initialise=function(t){t?(this.onInitialise===h.create()&&this.initialise(),l.log("initialise "+t),this.onInitialise(t,!1)):(l.log("initialise "+this),this.onInitialise=this.accept(new K,!1,this.onInitialise))},t.prototype.evaluate=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return this.onInitialise===h.create()&&this.initialise(),l.log(t+" evaluate message: "+e),K.evaluate.apply(K,[this,t].concat(e))},t.prototype.accept=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return t.visitStateMachine.apply(t,[this].concat(e))},t.prototype.toString=function(){return this.name},t}();n.StateMachine=C;var x=function(){function t(t,e,n){void 0===n&&(n=d.External);var r=this;this.source=t,this.target=e,this.kind=n,this.effectBehavior=h.create(),this.guard=t instanceof S?function(){return!0}:function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return e[0]===r.source},this.source.outgoing.push(this),this.target?(this.target.incoming.push(this),this.kind===d.Local&&(u.isChild(this.target,this.source)||(this.kind=d.External))):this.kind=d.Internal,this.source.invalidate()}return t.prototype.isElse=function(){return this.guard===t.Else},t.prototype.else=function(){return this.guard=t.Else,this},t.prototype.when=function(t){return this.guard=t,this},t.prototype.effect=function(t){return this.effectBehavior=h.create(this.effectBehavior,function(e,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return t.apply(void 0,[e].concat(r))}),this.source.invalidate(),this},t.prototype.evaluate=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return this.guard.apply(this,[t].concat(e))},t.prototype.accept=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return t.visitTransition.apply(t,[this].concat(e))},t}();x.Else=function(){return!1},n.Transition=x;var T=function(){function t(){}return t.prototype.visitElement=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n]},t.prototype.visitRegion=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var r=0,i=t.children;r<i.length;r++){var o=i[r];o.accept.apply(o,[this].concat(e))}return this.visitElement.apply(this,[t].concat(e))},t.prototype.visitVertex=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var r=0,i=t.outgoing;r<i.length;r++){var o=i[r];o.accept.apply(o,[this].concat(e))}return this.visitElement.apply(this,[t].concat(e))},t.prototype.visitPseudoState=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return this.visitVertex.apply(this,[t].concat(e))},t.prototype.visitState=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var r=0,i=t.children;r<i.length;r++){var o=i[r];o.accept.apply(o,[this].concat(e))}return this.visitVertex.apply(this,[t].concat(e))},t.prototype.visitStateMachine=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var r=0,i=t.children;r<i.length;r++){var o=i[r];o.accept.apply(o,[this].concat(e))}return this.visitElement.apply(this,[t].concat(e))},t.prototype.visitTransition=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n]},t}();n.Visitor=T;var I=function(){function t(t){this.name=t,this.children=new Array}return t}(),b=function(){function t(t){this.name=t,this.children=new Array}return t}(),k=function(){function t(t){this.root=new I(t)}return t.prototype.getStateConfiguration=function(t){var e=this.root;if(void 0!==t.parent){var n=this.getRegionConfiguration(t.parent);e=n.children.filter(function(e){return e.name===t.name})[0],void 0===e&&(e=new I(t.name),n.children.push(e))}return e},t.prototype.getRegionConfiguration=function(t){var e=this.getStateConfiguration(t.parent),n=e.children.filter(function(e){return e.name===t.name})[0];return void 0===n&&(n=new b(t.name),e.children.push(n)),n},t.prototype.setCurrent=function(t){var e=this.getRegionConfiguration(t.parent);e.current=t.name,t instanceof w&&(e.lastKnownState=t.name)},t.prototype.getCurrent=function(t){var e=this.getRegionConfiguration(t);return t.children.filter(function(t){return t.name===e.current})[0]},t.prototype.getLastKnownState=function(t){for(var e=this.getRegionConfiguration(t),n=void 0,r=0,i=t.children;r<i.length;r++){var o=i[r];o instanceof w&&o.name===e.lastKnownState&&(n=o)}return n},t.prototype.toJSON=function(){return JSON.stringify(this.root)},t.prototype.toString=function(){return this.root.name},t}();n.JSONInstance=k;var _=function(){function t(t){this.name=t,this.lastState={},this.currentVertex={}}return t.prototype.setCurrent=function(t){this.currentVertex[t.parent.toString()]=t,t instanceof w&&(this.lastState[t.parent.toString()]=t)},t.prototype.getCurrent=function(t){return this.currentVertex[t.toString()]},t.prototype.getLastKnownState=function(t){return this.lastState[t.toString()]},t.prototype.toString=function(){return this.name},t}();n.DictionaryInstance=_;var H=function(){function t(){this.leave=h.create(),this.beginEnter=h.create(),this.endEnter=h.create()}return t}(),K=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.actions={},e.transitions=new Array,e}return c(e,t),e.prototype.getActions=function(t){return this.actions[t.toString()]||(this.actions[t.toString()]=new H)},e.prototype.visitElement=function(t,e){this.getActions(t).leave=h.create(this.getActions(t).leave,function(e){return l.log(e+" leave "+t)}),this.getActions(t).beginEnter=h.create(this.getActions(t).beginEnter,function(e){return l.log(e+" enter "+t)})},e.prototype.visitRegion=function(e,n){var r=this,i=e.children.reduce(function(t,e){return e instanceof S&&y.isInitial(e.kind)&&(void 0===t||y.isHistory(t.kind))?e:t},void 0);this.getActions(e).leave=h.create(this.getActions(e).leave,function(t,n){for(var i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];(a=r.getActions(t.getCurrent(e))).leave.apply(a,[t,n].concat(i));var a}),t.prototype.visitRegion.call(this,e,n||i&&i.kind===y.DeepHistory),n||!i||y.isHistory(i.kind)?this.getActions(e).endEnter=h.create(this.getActions(e).endEnter,function(t,n){for(var o=[],a=2;a<arguments.length;a++)o[a-2]=arguments[a];var s=r.getActions(n||y.isHistory(i.kind)?t.getLastKnownState(e)||i:i),c=n||i.kind===y.DeepHistory;s.beginEnter.apply(s,[t,c].concat(o)),s.endEnter.apply(s,[t,c].concat(o))}):this.getActions(e).endEnter=h.create(this.getActions(e).endEnter,this.getActions(i).beginEnter,this.getActions(i).endEnter)},e.prototype.visitVertex=function(e,n){t.prototype.visitVertex.call(this,e,n),this.getActions(e).beginEnter=h.create(this.getActions(e).beginEnter,function(t){t.setCurrent(e)})},e.prototype.visitPseudoState=function(n,r){var i=this;t.prototype.visitPseudoState.call(this,n,r),y.isInitial(n.kind)&&(this.getActions(n).endEnter=h.create(this.getActions(n).endEnter,function(t,r){for(var o=[],a=2;a<arguments.length;a++)o[a-2]=arguments[a];if(t.getLastKnownState(n.parent)){(c=i.getActions(n)).leave.apply(c,[t,!1].concat(o));var s=t.getLastKnownState(n.parent);s&&((u=i.getActions(s)).beginEnter.apply(u,[t,r||n.kind===y.DeepHistory].concat(o)),(h=i.getActions(s)).endEnter.apply(h,[t,r||n.kind===y.DeepHistory].concat(o)))}else e.traverse(n.outgoing[0],t,!1);var c,u,h}))},e.prototype.visitState=function(t,e){for(var n=0,r=t.children;n<r.length;n++){var i=r[n];i.accept(this,e),this.getActions(t).leave=h.create(this.getActions(t).leave,this.getActions(i).leave),this.getActions(t).endEnter=h.create(this.getActions(t).endEnter,this.getActions(i).beginEnter,this.getActions(i).endEnter)}this.visitVertex(t,e),this.getActions(t).leave=h.create(this.getActions(t).leave,t.exitBehavior),this.getActions(t).beginEnter=h.create(this.getActions(t).beginEnter,t.entryBehavior)},e.prototype.visitStateMachine=function(e,n){var r=this;t.prototype.visitStateMachine.call(this,e,n);for(var i=0,o=this.transitions;i<o.length;i++){var a=o[i];switch(a.kind){case d.Internal:this.visitInternalTransition(a);break;case d.Local:this.visitLocalTransition(a);break;case d.External:this.visitExternalTransition(a)}}return h.create.apply(void 0,e.children.map(function(t){return h.create(r.getActions(t).beginEnter,r.getActions(t).endEnter)}))},e.prototype.visitTransition=function(e,n){t.prototype.visitTransition.call(this,e,n),this.transitions.push(e)},e.prototype.visitInternalTransition=function(t){t.onTraverse=h.create(t.effectBehavior),f&&(t.onTraverse=h.create(t.onTraverse,function(n,r){for(var i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];t.source instanceof w&&t.source.isComplete(n)&&e.evaluate(t.source,n,t.source)}))},e.prototype.visitLocalTransition=function(t){var e=this;t.onTraverse=h.create(function(n,r){for(var i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];for(var a=t.target,s=h.create(e.getActions(t.target).endEnter);a!==t.source;)s=h.create(e.getActions(a).beginEnter,s),s=a.parent.parent===t.source?h.create(t.effectBehavior,e.getActions(n.getCurrent(a.parent)).leave,s):h.create(e.getActions(a.parent).beginEnter,s),a=a.parent.parent;s.apply(void 0,[n,r].concat(i))})},e.prototype.visitExternalTransition=function(t){var e=u.ancestors(t.source),n=u.ancestors(t.target),r=u.lowestCommonAncestorIndex(e,n);for(e[r]instanceof A&&(r+=1),t.onTraverse=h.create(this.getActions(e[r]).leave,t.effectBehavior);r<n.length;)t.onTraverse=h.create(t.onTraverse,this.getActions(n[r++]).beginEnter);t.onTraverse=h.create(t.onTraverse,this.getActions(t.target).endEnter)},e.findElse=function(t){return t.outgoing.filter(function(t){return t.isElse()})[0]},e.selectTransition=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i=t.outgoing.filter(function(t){return t.evaluate.apply(t,[e].concat(n))});return t.kind===y.Choice?0!==i.length?i[p(i.length)]:this.findElse(t):(i.length>1&&l.error("Multiple outbound transition guards returned true at "+t+" for "+n),i[0]||this.findElse(t))},e.evaluate=function(t,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];var o=!1;if(r[0]!==t&&t.children.every(function(i){var a=n.getLastKnownState(i);return!a||!e.evaluate.apply(e,[a,n].concat(r))||(o=!0,t.isActive(n))}),t instanceof w)if(o)r[0]!==t&&t.isComplete(n)&&e.evaluate(t,n,t);else{var a=t.outgoing.filter(function(t){return t.evaluate.apply(t,[n].concat(r))});1===a.length?(e.traverse.apply(e,[a[0],n].concat(r)),o=!0):a.length>1&&l.error(t+": multiple outbound transitions evaluated true for message "+r)}return o},e.traverse=function(t,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];for(var o=h.create(t.onTraverse);t.target&&t.target instanceof S&&t.target.kind===y.Junction;)t=e.selectTransition.apply(e,[t.target,n].concat(r)),o=h.create(o,t.onTraverse);o.apply(void 0,[n,!1].concat(r)),t.target&&(t.target instanceof S&&t.target.kind===y.Choice?e.traverse.apply(e,[e.selectTransition.apply(e,[t.target,n].concat(r)),n].concat(r)):t.target instanceof w&&t.target.isComplete(n)&&e.evaluate(t.target,n,t.target))},e}(T)},{"./delegate":1,"./tree":3}],3:[function(t,e,n){"use strict";function r(t){var e=[];return t&&(t.parent&&e.push.apply(e,r(t.parent)),e.push(t)),e}function i(t,e){var n=0;if(t&&e)for(var r=Math.min(t.length,e.length);n<r&&t[n]===e[n];)n++;return n-1}function o(t,e){for(;t;){if(t.parent===e)return!0;t=t.parent}return!1}function a(t){for(var e=-1;t;)e++,t=t.parent;return e}n.__esModule=!0,n.ancestors=r,n.lowestCommonAncestorIndex=i,n.isChild=o,n.depth=a},{}],4:[function(t,e,n){window[((document.currentScript||document.getElementsByTagName("script")[scripts.length-1]).attributes.target||{textContent:"fsm"}).textContent]=t("../lib/node/state.js")},{"../lib/node/state.js":2}]},{},[4]);
