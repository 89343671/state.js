!function t(n,e,i){function r(s,a){if(!e[s]){if(!n[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(o)return o(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var h=e[s]={exports:{}};n[s][0].call(h.exports,function(t){var e=n[s][1][t];return r(e?e:t)},h,h.exports,t,n,e,i)}return e[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s]);return r}({1:[function(t,n,e){"use strict";function i(t){var n=e.logger;return e.logger=t,n}function r(t){var n=e.random;return e.random=t,n}function o(t){var n=e.internalTransitionsTriggerCompletion;return e.internalTransitionsTriggerCompletion=t,n}function s(t,n,e,i){for(var r=0,o=t;r<o.length;r++){var s=o[r];s(n,e,i)}}function a(t){return t.outgoing.filter(function(t){return t.guard===S.Else})[0]}function c(t,n,i){var r=t.outgoing.filter(function(t){return t.guard(n,i)});return t.kind===g.Choice?0!==r.length?r[e.random(r.length)]:a(t):(r.length>1&&e.logger.error("Multiple outbound transition guards returned true at "+t+" for "+i),r[0]||a(t))}function u(t,n,i){var r=!1;if(i!==t&&t.children.every(function(e){var o=n.getLastKnownState(e);return!o||!u(o,n,i)||(r=!0,t.isActive(n))}),t instanceof E)if(r)i!==t&&t.isComplete(n)&&u(t,n,t);else{var o=t.outgoing.filter(function(t){return t.guard(n,i)});1===o.length?(h(o[0],n,i),r=!0):o.length>1&&e.logger.error(t+": multiple outbound transitions evaluated true for message "+i)}return r}function h(t,n,e){for(var i=t.onTraverse.slice(),r=t;r.target&&r.target instanceof A&&r.target.kind===g.Junction;)r=c(r.target,n,e),i=i.concat(r.onTraverse);s(i,n,!1,e),r.target&&(r.target instanceof A&&r.target.kind===g.Choice?h(c(r.target,n,e),n,e):r.target instanceof E&&r.target.isComplete(n)&&u(r.target,n,r.target))}var l=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)n.hasOwnProperty(e)&&(t[e]=n[e])};return function(n,e){function i(){this.constructor=n}t(n,e),n.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();e.__esModule=!0;var p=t("./tree");e.logger={log:function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e]},error:function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];throw t}},e.setLogger=i,e.random=function(t){return Math.floor(Math.random()*t)},e.setRandom=r,e.internalTransitionsTriggerCompletion=!1,e.setInternalTransitionsTriggerCompletion=o;var f=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return l(n,t),n}(Array);e.Actions=f;var g;!function(t){t[t.Choice=0]="Choice",t[t.DeepHistory=1]="DeepHistory",t[t.Initial=2]="Initial",t[t.Junction=3]="Junction",t[t.ShallowHistory=4]="ShallowHistory"}(g=e.PseudoStateKind||(e.PseudoStateKind={}));var v;!function(t){t[t.External=0]="External",t[t.Internal=1]="Internal",t[t.Local=2]="Local"}(v=e.TransitionKind||(e.TransitionKind={}));var y=function(){function t(n,e){this.name=n,this.parent=e,this.children=new Array,this.qualifiedName=e?e.toString()+t.namespaceSeparator+n:n}return t.prototype.getRoot=function(){return this.parent.getRoot()},t.prototype.isActive=function(t){return this.parent.isActive(t)},t.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitElement.apply(t,[this].concat(n))},t.prototype.toString=function(){return this.qualifiedName},t}();y.namespaceSeparator=".",e.Element=y;var d=function(t){function n(n,e){var i=t.call(this,n,e)||this;return i.parent.children.push(i),i.getRoot().clean=!1,i}return l(n,t),n.prototype.isComplete=function(t){var n=t.getLastKnownState(this);return void 0!==n&&n.isFinal()},n.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitRegion.apply(t,[this].concat(n))},n}(y);d.defaultName="default",e.Region=d;var m=function(t){function n(n,e){var i=t.call(this,n,e instanceof d?e:E.defaultRegion(e))||this;return i.outgoing=new Array,i.incoming=new Array,i.parent.children.push(i),i.getRoot().clean=!1,i}return l(n,t),n.prototype.to=function(t,n){return void 0===n&&(n=v.External),new S(this,t,n)},n.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitVertex.apply(t,[this].concat(n))},n}(y);e.Vertex=m;var A=function(t){function n(n,e,i){void 0===i&&(i=g.Initial);var r=t.call(this,n,e)||this;return r.kind=i,r}return l(n,t),n.prototype.isHistory=function(){return this.kind===g.DeepHistory||this.kind===g.ShallowHistory},n.prototype.isInitial=function(){return this.kind===g.Initial||this.isHistory()},n.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitPseudoState.apply(t,[this].concat(n))},n}(m);e.PseudoState=A;var E=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.entryBehavior=new f,n.exitBehavior=new f,n}return l(n,t),n.defaultRegion=function(t){for(var n=0,e=t.children;n<e.length;n++){var i=e[n];if(i.name===d.defaultName)return i}return new d(d.defaultName,t)},n.prototype.isFinal=function(){return 0===this.outgoing.length},n.prototype.isSimple=function(){return 0===this.children.length},n.prototype.isComposite=function(){return this.children.length>0},n.prototype.isOrthogonal=function(){return this.children.length>1},n.prototype.isActive=function(n){return t.prototype.isActive.call(this,n)&&n.getLastKnownState(this.parent)===this},n.prototype.isComplete=function(t){return this.children.every(function(n){return n.isComplete(t)})},n.prototype.exit=function(t){return this.exitBehavior.push(function(n,e,i){t(n,i)}),this.getRoot().clean=!1,this},n.prototype.entry=function(t){return this.entryBehavior.push(function(n,e,i){t(n,i)}),this.getRoot().clean=!1,this},n.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitState.apply(t,[this].concat(n))},n}(m);e.State=E;var w=function(){function t(t){this.name=t,this.children=new Array,this.clean=!1,this.onInitialise=new f,this.parent=void 0}return t.prototype.getRoot=function(){return this},t.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitStateMachine.apply(t,[this].concat(n))},t.prototype.isActive=function(t){return!0},t.prototype.isComplete=function(t){return this.children.every(function(n){return n.isComplete(t)})},t.prototype.initialise=function(t){t?(this.clean===!1&&this.initialise(),e.logger.log("initialise "+t),s(this.onInitialise,t,!1,void 0)):(e.logger.log("initialise "+this),this.accept(new I,!1),this.clean=!0)},t.prototype.evaluate=function(t,n){return this.clean===!1&&this.initialise(),e.logger.log(t+" evaluate message: "+n),u(this,t,n)},t.prototype.toString=function(){return this.name},t}();e.StateMachine=w;var S=function(){function t(t,n,e){void 0===e&&(e=v.External);var i=this;this.source=t,this.target=n,this.kind=e,this.effectBehavior=new f,this.onTraverse=new f,this.guard=t instanceof A?function(t,n){return!0}:function(t,n){return n===i.source},this.source.outgoing.push(this),this.source.getRoot().clean=!1,this.target?this.target.incoming.push(this):this.kind=v.Internal}return t.prototype.else=function(){return this.guard=t.Else,this},t.prototype.when=function(t){return this.guard=t,this},t.prototype.effect=function(t){return this.effectBehavior.push(function(n,e,i){t(n,i)}),this.source.getRoot().clean=!1,this},t.prototype.accept=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];t.visitTransition.apply(t,[this].concat(n))},t.prototype.toString=function(){return v[this.kind]+"("+(this.kind===v.Internal?this.source:this.source+" -> "+this.target)+")"},t}();S.Else=function(t,n){return!1},e.Transition=S;var T=function(){function t(){}return t.prototype.visitElement=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e]},t.prototype.visitRegion=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=0,r=t.children;i<r.length;i++){var o=r[i];o.accept.apply(o,[this].concat(n))}this.visitElement.apply(this,[t].concat(n))},t.prototype.visitVertex=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=0,r=t.outgoing;i<r.length;i++){var o=r[i];o.accept.apply(o,[this].concat(n))}this.visitElement.apply(this,[t].concat(n))},t.prototype.visitPseudoState=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];this.visitVertex.apply(this,[t].concat(n))},t.prototype.visitState=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=0,r=t.children;i<r.length;i++){var o=r[i];o.accept.apply(o,[this].concat(n))}this.visitVertex.apply(this,[t].concat(n))},t.prototype.visitStateMachine=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e];for(var i=0,r=t.children;i<r.length;i++){var o=r[i];o.accept.apply(o,[this].concat(n))}this.visitElement.apply(this,[t].concat(n))},t.prototype.visitTransition=function(t){for(var n=[],e=1;e<arguments.length;e++)n[e-1]=arguments[e]},t}();e.Visitor=T;var C=function(){function t(t){this.name=t,this.current={},this.activeStateConfiguration={}}return t.prototype.setCurrent=function(t,n){this.current[t.qualifiedName]=n,n instanceof E&&(this.activeStateConfiguration[t.qualifiedName]=n)},t.prototype.getCurrent=function(t){return this.current[t.qualifiedName]},t.prototype.getLastKnownState=function(t){return this.activeStateConfiguration[t.qualifiedName]},t.prototype.toString=function(){return this.name},t}();e.DictionaryInstance=C;var x=function(){function t(){this.leave=new f,this.beginEnter=new f,this.endEnter=new f}return t}(),I=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.elementActions={},n.transitions=new Array,n}return l(n,t),n.prototype.getActions=function(t){return this.elementActions[t.toString()]||(this.elementActions[t.toString()]=new x)},n.prototype.visitElement=function(t,n){this.getActions(t).leave.push(function(n,i,r){return e.logger.log(n+" leave "+t)}),this.getActions(t).beginEnter.push(function(n,i,r){return e.logger.log(n+" enter "+t)})},n.prototype.visitRegion=function(n,e){var i=this,r=n.children.reduce(function(t,n){return n instanceof A&&n.isInitial()&&(void 0===t||t.isHistory())?n:t},void 0);this.getActions(n).leave.push(function(t,e,r){var o=t.getCurrent(n);o&&s(i.getActions(o).leave,t,!1,r)}),t.prototype.visitRegion.call(this,n,e||r&&r.kind===g.DeepHistory),e||!r||r.isHistory()?this.getActions(n).endEnter.push(function(t,e,o){var a=i.getActions(e||r.isHistory()?t.getLastKnownState(n)||r:r),c=e||r.kind===g.DeepHistory;s(a.beginEnter,t,c,o),s(a.endEnter,t,c,o)}):this.getActions(n).endEnter=this.getActions(n).endEnter.concat(this.getActions(r).beginEnter,this.getActions(r).endEnter)},n.prototype.visitVertex=function(n,e){t.prototype.visitVertex.call(this,n,e),this.getActions(n).beginEnter.push(function(t,e,i){t.setCurrent(n.parent,n)})},n.prototype.visitPseudoState=function(n,e){var i=this;t.prototype.visitPseudoState.call(this,n,e),n.isInitial()&&this.getActions(n).endEnter.push(function(t,e,r){if(t.getLastKnownState(n.parent)){s(i.getActions(n).leave,t,!1,r);var o=t.getLastKnownState(n.parent);o&&(s(i.getActions(o).beginEnter,t,e||n.kind===g.DeepHistory,r),s(i.getActions(o).endEnter,t,e||n.kind===g.DeepHistory,r))}else h(n.outgoing[0],t,!1)})},n.prototype.visitState=function(t,n){for(var e=0,i=t.children;e<i.length;e++){var r=i[e];r.accept(this,n),this.getActions(t).leave=this.getActions(t).leave.concat(this.getActions(r).leave),this.getActions(t).endEnter=this.getActions(t).endEnter.concat(this.getActions(r).beginEnter,this.getActions(r).endEnter)}this.visitVertex(t,n),this.getActions(t).leave=this.getActions(t).leave.concat(t.exitBehavior),this.getActions(t).beginEnter=this.getActions(t).beginEnter.concat(t.entryBehavior)},n.prototype.visitStateMachine=function(n,e){t.prototype.visitStateMachine.call(this,n,e);for(var i=0,r=this.transitions;i<r.length;i++){var o=r[i];switch(o.kind){case v.Internal:this.visitInternalTransition(o);break;case v.Local:this.visitLocalTransition(o);break;case v.External:this.visitExternalTransition(o)}}for(var s=0,a=n.children;s<a.length;s++){var c=a[s];n.onInitialise=n.onInitialise.concat(this.getActions(c).beginEnter,this.getActions(c).endEnter)}},n.prototype.visitTransition=function(n,e){t.prototype.visitTransition.call(this,n,e),this.transitions.push(n)},n.prototype.visitInternalTransition=function(t){t.onTraverse=t.onTraverse.concat(t.effectBehavior),e.internalTransitionsTriggerCompletion&&t.onTraverse.push(function(n,e,i){t.source instanceof E&&t.source.isComplete(n)&&u(t.source,n,t.source)})},n.prototype.visitLocalTransition=function(t){var n=this;t.onTraverse.push(function(e,i,r){for(var o=p.Ancestors(t.target),a=0;o[a].isActive(e);)a++;if(o[a]instanceof d)throw"Need to implement Region logic";var c=o[a],u=e.getCurrent(c.parent);for(s(n.getActions(u).leave,e,!1,r),s(t.effectBehavior,e,!1,r);a<o.length;)s(n.getActions(o[a++]).beginEnter,e,!1,r);s(n.getActions(t.target).endEnter,e,!1,r)})},n.prototype.visitExternalTransition=function(t){var n=p.Ancestors(t.source),e=p.Ancestors(t.target),i=p.LowestCommonAncestorIndex(n,e);for(n[i]instanceof d&&(i+=1),t.onTraverse=t.onTraverse.concat(this.getActions(n[i]).leave,t.effectBehavior);i<e.length;)t.onTraverse=t.onTraverse.concat(this.getActions(e[i++]).beginEnter);t.onTraverse=t.onTraverse.concat(this.getActions(t.target).endEnter)},n}(T)},{"./tree":2}],2:[function(t,n,e){"use strict";function i(t){var n=t.parent?i(t.parent):new Array;return n.push(t),n}function r(t,n){for(var e=0;e<t.length&&e<n.length&&t[e]===n[e];)e++;return e-1}e.__esModule=!0,e.Ancestors=i,e.LowestCommonAncestorIndex=r},{}],3:[function(t,n,e){window[((document.currentScript||document.getElementsByTagName("script")[scripts.length-1]).attributes.target||{textContent:"fsm"}).textContent]=t("../lib/node/state.js")},{"../lib/node/state.js":1}]},{},[3]);
